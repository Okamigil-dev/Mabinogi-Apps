<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Music Buff Calculator</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* V2.7 Theme */
            --bg: #09090b;
            --sidebar-bg: #121214;
            --card-bg: #18181b;
            
            /* Theme: Pink/Rose for Bard */
            --accent: #f43f5e; 
            --accent-dim: rgba(244, 63, 94, 0.1);
            
            --border: #27272a;
            --text-main: #e4e4e7;
            --text-dim: #a1a1aa;
            --danger: #ef4444;
            --success: #00ff88;
            --gold: #fbbf24; /* New Gold for Inspiring */
            --gold-dim: rgba(251, 191, 36, 0.1);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text-main);
            margin: 0;
            font-size: 13px;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- Global Nav --- */
        .global-nav {
            display: flex; align-items: center; gap: 20px; padding: 0 20px; height: 40px;
            background: #050506; border-bottom: 1px solid var(--border); flex-shrink: 0;
        }
        .global-nav a {
            font-size: 11px; font-weight: 700; color: var(--text-dim); text-decoration: none;
            letter-spacing: 0.5px; transition: color 0.2s;
            display: flex; align-items: center; gap: 6px;
        }
        .global-nav a:hover { color: #fff; }
        .global-nav a.active { color: var(--accent); }
        
        .nav-icon { 
            width: 14px; height: 14px; stroke-width: 2.5; stroke: currentColor; fill: none; 
            stroke-linecap: round; stroke-linejoin: round; opacity: 0.8; 
        }
        .global-nav a:hover .nav-icon, .global-nav a.active .nav-icon { opacity: 1; }

        /* Layout */
        .interface-container { display: flex; flex-direction: column; height: 100%; width: 100%; }
        .header-bar { background: var(--sidebar-bg); border-bottom: 1px solid var(--border); padding: 10px 20px; flex-shrink: 0; }
        .title-section { display: flex; justify-content: space-between; align-items: center; }
        .main-title { font-size: 16px; font-weight: 700; color: #fff; letter-spacing: 0.5px; }

        .content-grid { display: grid; grid-template-columns: 320px 1fr 340px; flex-grow: 1; overflow: hidden; }
        .panel { background: var(--bg); display: flex; flex-direction: column; border-right: 1px solid var(--border); overflow-y: auto; }
        .panel:last-child { border-right: none; }
        .center-panel { background: #0c0c0e; display: flex; flex-direction: column; padding: 20px; align-items: center; justify-content: center; }

        /* Components */
        .panel-label { font-size: 11px; font-weight: 600; color: var(--text-dim); margin-bottom: 8px; display: block; text-transform: uppercase; }
        .config-section { padding: 20px; border-bottom: 1px solid var(--border); }
        
        .input-dark { background: var(--card-bg); border: 1px solid var(--border); color: #fff; font-family: 'Inter', sans-serif; font-size: 13px; padding: 8px; border-radius: 6px; width: 100%; transition: border-color 0.2s; }
        .input-dark:focus { border-color: var(--accent); }
        select.input-dark { cursor: pointer; }
        
        .hub-btn { 
            color: var(--text-dim); text-decoration: none; font-weight: 600; font-size: 12px; 
            padding: 8px 12px; border-radius: 6px; transition: 0.2s; 
            border: 1px solid transparent; background: transparent; cursor: pointer; text-align: left; width: 100%;
            display: flex; align-items: center; gap: 10px;
        }
        .hub-btn:hover { color: #fff; background: var(--border); }
        .hub-btn.active { color: var(--accent); background: var(--accent-dim); border-color: var(--accent); }
        
        /* Stats Box - UPDATED for better dashboard look */
        .result-card {
            background: var(--card-bg); border: 1px solid var(--border); border-radius: 16px;
            padding: 25px; width: 100%; max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative; overflow: hidden;
        }
        .result-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: var(--accent);
        }
        
        .main-stat-display { text-align: center; margin-bottom: 25px; }
        .stat-label-main { font-size: 12px; color: var(--text-dim); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 5px; }
        .stat-val-main { font-family: 'JetBrains Mono', monospace; font-size: 42px; font-weight: 700; color: #fff; text-shadow: 0 0 20px var(--accent-dim); }

        .sub-stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border); }
        .sub-stat { text-align: center; }
        .sub-val { font-family: 'JetBrains Mono', monospace; font-size: 18px; font-weight: 700; color: var(--text-main); }
        .sub-label { font-size: 10px; color: var(--text-dim); text-transform: uppercase; margin-top: 2px; }

        /* Specific row for result listing */
        .res-list { display: flex; flex-direction: column; gap: 8px; }
        .res-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 12px; background: rgba(255,255,255,0.03); border-radius: 6px;
        }
        .res-name { font-size: 12px; color: var(--text-dim); text-transform: uppercase; font-weight: 600; }
        .res-val { font-family: 'JetBrains Mono'; font-weight: 700; color: var(--accent); font-size: 15px; }

        /* Stat Input Row */
        .stat-input-row {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 8px;
        }
        .stat-name { font-size: 11px; color: #ccc; }
        .stat-input {
            width: 70px; text-align: right; font-family: 'JetBrains Mono'; font-size:12px;
        }
        
        /* Toggles - UPDATED SPACING */
        .toggle-row { 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 3px 0; /* Reduced padding */
            margin-bottom: 4px; /* Reduced margin */
            cursor: pointer; 
        }
        .toggle-switch { width: 32px; height: 18px; background: var(--border); border-radius: 99px; position: relative; transition: 0.2s; flex-shrink: 0; }
        .toggle-switch::after { content: ''; position: absolute; top: 2px; left: 2px; width: 14px; height: 14px; background: #fff; border-radius: 50%; transition: 0.2s; }
        input:checked + .toggle-switch { background: var(--accent); }
        input:checked + .toggle-switch::after { transform: translateX(14px); }
        .toggle-input { display: none; }

        /* Accordion */
        details { width: 100%; margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 10px; }
        details:last-child { border-bottom: none; }
        summary { cursor: pointer; font-size: 12px; font-weight: 600; color: var(--text-main); margin-bottom: 10px; list-style: none; display: flex; align-items: center; gap: 6px; }
        summary::before { content: '▶'; font-size: 8px; transition: 0.2s; }
        details[open] summary::before { transform: rotate(90deg); color: var(--accent); }

        /* Mobile */
        .mobile-nav { display: none; }
        .mobile-backdrop { display: none; }
        .mobile-only { display: none; }
        .drawer-header { display: none; }

        @media (max-width: 1000px) {
            .mobile-only { display: block; }
            .content-grid { display: block; height: calc(100dvh - 50px); }
            .header-bar { display: none; }
            .global-nav { display: none; }

            .mobile-nav { 
                display: flex; justify-content: space-between; align-items: center; 
                padding: 10px 15px; background: var(--sidebar-bg); border-bottom: 1px solid var(--border); 
                height: 50px; z-index: 50; flex-shrink: 0;
            }
            .nav-trigger { background: transparent; border: 1px solid var(--border); color: var(--text-main); padding: 6px 12px; border-radius: 6px; font-size: 14px; cursor: pointer; }
            
            .left-panel, .right-panel {
                position: fixed; top: 0; bottom: 0; width: 300px; max-width: 85%; z-index: 1001; 
                box-shadow: 0 0 50px rgba(0,0,0,0.8); 
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.3s;
                visibility: hidden; 
            }
            .left-panel { left: 0; transform: translateX(-100%); border-right: 1px solid var(--border); }
            .right-panel { right: 0; transform: translateX(100%); border-left: 1px solid var(--border); }
            .left-panel.active, .right-panel.active { transform: translateX(0); visibility: visible; }
            
            .center-panel { height: 100%; width: 100%; border: none; padding: 20px; overflow-y: auto; }
            .mobile-backdrop { display: block; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s; backdrop-filter: blur(4px); }
            .mobile-backdrop.active { opacity: 1; pointer-events: all; }
            
            .drawer-header { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid var(--border); background: var(--sidebar-bg); }
            .drawer-title { font-weight: 700; color: #fff; }
            .drawer-close { background: none; border: none; color: var(--text-dim); font-size: 20px; padding: 0 5px; cursor: pointer; }
        }
    </style>
</head>
<body>

    <!-- Mobile Navigation -->
    <div class="mobile-nav">
        <div style="display:flex; gap:12px; align-items:center;">
             <button class="nav-trigger" onclick="window.location.href='index.html'" style="padding: 6px 10px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
            </button>
            <button class="nav-trigger" onclick="toggleSidebar('left')">♫ Config</button>
        </div>
        <span style="font-weight:700; color:#fff;">Music Calc</span>
        <button class="nav-trigger" onclick="toggleSidebar('right')">Bonuses ♪</button>
    </div>

    <div class="mobile-backdrop" id="mobile-backdrop" onclick="closeSidebars()"></div>

    <div class="interface-container">
        <!-- GLOBAL NAVIGATION BAR -->
        <nav class="global-nav">
            <a href="index.html">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></polyline></svg>
                HOME
            </a>
            <a href="tracker.html">
                <svg class="nav-icon" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                TRACKER
            </a>
            <a href="barter.html">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M7 10h14l-4-4"/><path d="M17 14H3l4 4"/></svg>
                BARTER
            </a>
            <a href="commerce.html">
                <svg class="nav-icon" viewBox="0 0 24 24"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
                COMMERCE
            </a>
            <a href="wishlist.html">
                <svg class="nav-icon" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                WISHLIST
            </a>
            <a href="calculators.html">
                <svg class="nav-icon" viewBox="0 0 24 24"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="16" y1="14" x2="16" y2="14"/><line x1="8" y1="14" x2="8" y2="14"/><line x1="12" y1="14" x2="12" y2="14"/><line x1="16" y1="18" x2="16" y2="18"/><line x1="8" y1="18" x2="8" y2="18"/><line x1="12" y1="18" x2="12" y2="18"/></svg>
                CALCULATORS
            </a>
            <a href="simulator.html" class="active">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
                SIMULATOR
            </a>
        </nav>

        <!-- Desktop Header -->
        <div class="header-bar">
            <div class="title-section">
                <div style="display:flex; align-items:center;">
                    <span class="main-title">MUSIC BUFF CALCULATOR</span>
                </div>
                <div style="display:flex; gap:12px; align-items:center;">
                    <div style="text-align:right;">
                        <div id="user-info" style="font-size:12px; font-weight:600; color:var(--text-main);">Guest</div>
                        <div id="connection-status" style="font-size:10px; color:var(--text-dim);">Local Mode</div>
                    </div>
                    <!-- User Avatar Added -->
                    <div id="user-avatar" style="width: 36px; height: 36px; border-radius: 50%; background-color: var(--card-bg); border: 1px solid var(--border); background-size: cover; background-position: center; background-image: url('data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\' fill=\'%23a1a1aa\'%3E%3Cpath d=\'M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z\'/%3E%3C/svg%3E');"></div>
                </div>
            </div>
        </div>

        <div class="content-grid">
            <!-- LEFT PANEL: Skill & Performance -->
            <div class="panel left-panel" id="left-panel">
                <div class="drawer-header">
                    <span class="drawer-title">Config</span>
                    <button class="drawer-close" onclick="closeSidebars()">×</button>
                </div>
                
                <div class="config-section">
                    <label class="panel-label">Active Buff</label>
                    <select id="active-song" class="input-dark" onchange="updateUI()">
                        <option value="bfo">Battlefield Overture</option>
                        <option value="vivace">Vivace</option>
                        <option value="march">March Song</option>
                        <option value="harvest">Harvest Song</option>
                        <option value="enduring">Enduring Melody</option>
                    </select>

                    <label class="panel-label" style="margin-top:15px;">Skill Rank</label>
                    <select id="skill-rank" class="input-dark" onchange="calc()">
                        <option value="N">Rank N</option>
                        <option value="F">Rank F</option>
                        <option value="E">Rank E</option>
                        <option value="D">Rank D</option>
                        <option value="C">Rank C</option>
                        <option value="B">Rank B</option>
                        <option value="A">Rank A</option>
                        <option value="9">Rank 9</option>
                        <option value="8">Rank 8</option>
                        <option value="7">Rank 7</option>
                        <option value="6">Rank 6</option>
                        <option value="5">Rank 5</option>
                        <option value="4">Rank 4</option>
                        <option value="3">Rank 3</option>
                        <option value="2">Rank 2</option>
                        <option value="1" selected>Rank 1</option>
                    </select>
                </div>
                
                <div class="config-section" style="border-bottom:none;">
                    <label class="panel-label">Performance Details</label>
                    
                    <details open>
                        <summary>Quality & MK Reforges</summary>
                         <label class="panel-label" style="margin-top:5px;">Performance Quality</label>
                        <select id="perf-type" class="input-dark" onchange="calc()" style="margin-bottom:12px;">
                            <option value="1.0">Ordinary (100%)</option>
                            <option value="1.1">Excellent (110%)</option>
                            <option value="1.3">Inspiring (130%)</option>
                        </select>
                        <div class="stat-input-row">
                            <span class="stat-name">MK Normal Reforge (Lvl)</span>
                            <input type="number" id="reforge-mk-norm" class="input-dark stat-input" value="0" placeholder="Lvl" oninput="calc()">
                        </div>
                        <div class="stat-input-row">
                            <span class="stat-name">MK Exc. Reforge (Lvl)</span>
                            <input type="number" id="reforge-mk-exc" class="input-dark stat-input" value="0" placeholder="Lvl" oninput="calc()">
                        </div>
                        <div class="stat-input-row">
                            <span class="stat-name">MK Insp. Reforge (Lvl)</span>
                            <input type="number" id="reforge-mk-insp" class="input-dark stat-input" value="0" placeholder="Lvl" oninput="calc()">
                        </div>
                         <!-- NEW INPUT: MK Inspiring (Accessory) -->
                        <div class="stat-input-row" id="mk-insp-acc-row" style="display:flex;">
                            <span class="stat-name" style="color:var(--accent);">MK Insp. (Acc) (Lvl)</span>
                            <input type="number" id="reforge-mk-insp-acc" class="input-dark stat-input" value="0" placeholder="Lvl" oninput="updateAcc(this.value)">
                        </div>
                    </details>

                                        <!-- DYNAMIC SPECIFIC REFORGES (Moved Here) -->
                    <div id="specific-reforge-area" style="padding:10px 0; border-bottom:1px dashed var(--border); margin-bottom:10px;">
                         <!-- Populated by JS based on song -->
                    </div>

                    <!-- Harvest Song Party (Moved Here) -->
                    <div id="harvest-party-container" style="display:none; margin-bottom:10px;">
                        <div class="stat-input-row">
                            <span class="stat-name" style="color:var(--accent);">Party Members</span>
                            <input type="number" id="party-members" class="input-dark stat-input" value="1" min="1" max="16" oninput="calc()">
                        </div>
                    </div>
                    
                    <details open>
                        <summary>Inspiring Rates</summary>
                        <div class="toggle-row">
                            <span class="stat-name">Harmonic Saint Link 10</span>
                            <label><input type="checkbox" id="link-saint-10" class="toggle-input" onchange="calc()"><div class="toggle-switch"></div></label>
                        </div>
                        <div class="stat-input-row">
                            <span class="stat-name">Inspiring Success Reforge (Lvl)</span>
                            <input type="number" id="reforge-insp-rate" class="input-dark stat-input" value="0" placeholder="Lvl" oninput="calc()">
                        </div>
                    </details>
                </div>
            </div>

            <!-- CENTER PANEL: Output -->
            <div class="panel center-panel">
                <!-- Result Card -->
                <div class="result-card">
                    <div class="main-stat-display">
                        <div class="stat-label-main" id="res-label">FINAL EFFECTS</div>
                        <div id="result-container" class="res-list">
                            <!-- Results go here -->
                        </div>
                    </div>
                    
                    <div class="sub-stat-grid">
                        <div class="sub-stat">
                            <div class="sub-val" id="res-buff-stat">0</div>
                            <div class="sub-label">Buff Bonus Sum</div>
                        </div>
                        <div class="sub-stat">
                            <div class="sub-val" id="res-insp-chance" style="color:var(--gold);">0.00%</div>
                            <div class="sub-label" style="color:var(--gold);">Inspiring Chance</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT PANEL: Additive Bonuses -->
            <div class="panel right-panel" id="right-panel">
                <div class="drawer-header">
                    <span class="drawer-title">Bonuses</span>
                    <button class="drawer-close" onclick="closeSidebars()">×</button>
                </div>
                
                <div class="config-section">
                    <label class="panel-label">Music Buff Effect Sources</label>
                    
                    <!-- SKILLS & TALENTS -->
                    <details open>
                        <summary>Ranks & Talents</summary>
                        <div class="stat-input-row">
                            <span class="stat-name">Playing Inst. Rank</span>
                            <select id="rank-pi" class="input-dark stat-input" style="width:140px;" onchange="calc()">
                                <option value="0">Rank N</option>
                                <option value="1">Rank F (+1)</option>
                                <option value="2">Rank E (+2)</option>
                                <option value="3">Rank D (+3)</option>
                                <option value="4">Rank C (+4)</option>
                                <option value="5">Rank B (+5)</option>
                                <option value="6">Rank A (+6)</option>
                                <option value="7">Rank 9 (+7)</option>
                                <option value="8">Rank 8 (+8)</option>
                                <option value="9">Rank 7 (+9)</option>
                                <option value="10">Rank 6 (+10)</option>
                                <option value="11">Rank 5 (+11)</option>
                                <option value="12">Rank 4 (+12)</option>
                                <option value="13">Rank 3 (+13)</option>
                                <option value="14">Rank 2 (+14)</option>
                                <option value="15" selected>Rank 1 (+15)</option>
                            </select>
                        </div>
                        <div class="stat-input-row">
                            <span class="stat-name">Song Rank</span>
                            <select id="rank-song" class="input-dark stat-input" style="width:140px;" onchange="calc()">
                                <option value="0">Rank N</option>
                                <option value="1">Rank F (+1)</option>
                                <option value="2">Rank E (+2)</option>
                                <option value="3">Rank D (+3)</option>
                                <option value="4">Rank C (+4)</option>
                                <option value="5">Rank B (+5)</option>
                                <option value="6">Rank A (+6)</option>
                                <option value="7">Rank 9 (+7)</option>
                                <option value="8">Rank 8 (+8)</option>
                                <option value="9">Rank 7 (+9)</option>
                                <option value="10">Rank 6 (+10)</option>
                                <option value="11">Rank 5 (+11)</option>
                                <option value="12">Rank 4 (+12)</option>
                                <option value="13">Rank 3 (+13)</option>
                                <option value="14">Rank 2 (+14)</option>
                                <option value="15" selected>Rank 1 (+15)</option>
                            </select>
                        </div>
                        <div class="toggle-row">
                            <span class="stat-name">Grandmaster Bard (+5)</span>
                            <label><input type="checkbox" id="gm-bard" class="toggle-input" onchange="calc()"><div class="toggle-switch"></div></label>
                        </div>
                    </details>
                    
                    <!-- GEAR -->
                    <details open>
                        <summary>Equipment</summary>
                        <div class="stat-input-row">
                            <span class="stat-name">Enchants Total</span>
                            <input type="number" id="ench-total" class="input-dark stat-input" value="0" oninput="calc()">
                        </div>
                        <div class="stat-input-row">
                            <span class="stat-name">Upgrade Effect</span>
                            <input type="number" id="upg-total" class="input-dark stat-input" value="0" oninput="calc()">
                        </div>
                        <div class="toggle-row">
                            <span class="stat-name">Troubadour Set (+3)</span>
                            <label><input type="checkbox" id="set-troubadour" class="toggle-input" onchange="toggleSets('troub')"><div class="toggle-switch"></div></label>
                        </div>
                        <div class="toggle-row" id="seraphic-set-container">
                            <span class="stat-name">Seraphic Cant. (+5 BFO)</span>
                            <label><input type="checkbox" id="set-seraphic" class="toggle-input" onchange="toggleSets('seraph')"><div class="toggle-switch"></div></label>
                        </div>
                         <div class="stat-input-row">
                            <span class="stat-name">Fleur's Tiara</span>
                            <input type="number" id="tiara-val" class="input-dark stat-input" value="0" oninput="calc()">
                        </div>
                         <div class="stat-input-row">
                            <span class="stat-name" style="color:var(--text-dim);">Item Grade Effect %</span>
                            <input type="number" id="item-grade" class="input-dark stat-input" value="0" placeholder="%" oninput="calc()">
                        </div>
                        <div class="stat-input-row">
                            <span class="stat-name" style="color:var(--text-dim);">Special Upgrade Effect %</span>
                            <input type="number" id="special-upgrade" class="input-dark stat-input" value="0" placeholder="%" oninput="calc()">
                        </div>
                    </details>
                    
                    <!-- REFORGES -->
                    <details open>
                        <summary>Reforges (Buff Effect)</summary>
                         <div class="stat-input-row">
                            <span class="stat-name">Playing Inst. Effect (Lvl)</span>
                            <input type="number" id="reforge-pi" class="input-dark stat-input" value="0" oninput="calc()">
                        </div>
                    </details>

                    <!-- EXTERNAL -->
                    <details>
                        <summary>External & Titles</summary>
                        <div class="stat-input-row">
                            <span class="stat-name">1st Title Bonus</span>
                            <input type="number" id="title-1" class="input-dark" value="8" oninput="calc()">
                        </div>
                        <div class="stat-input-row">
                            <span class="stat-name">2nd Title Bonus</span>
                            <input type="number" id="title-2" class="input-dark" value="0" oninput="calc()">
                        </div>
                         <div class="toggle-row">
                            <span class="stat-name">Music Buff Potion (+2)</span>
                            <label><input type="checkbox" id="buff-pot" class="toggle-input" onchange="calc()"><div class="toggle-switch"></div></label>
                        </div>
                         <div class="toggle-row">
                            <span class="stat-name">Harmonic Saint Link (+3)</span>
                            <label><input type="checkbox" id="link-bonus" class="toggle-input" onchange="calc()"><div class="toggle-switch"></div></label>
                        </div>
                         <div class="stat-input-row">
                            <span class="stat-name">Homestead Bonus</span>
                            <input type="number" id="homestead-val" class="input-dark stat-input" value="0" oninput="calc()">
                        </div>
                    </details>

                    <!-- PETS -->
                    <details>
                        <summary>Active Pet</summary>
                        <div class="stat-input-row">
                            <select id="pet-select" class="input-dark" onchange="calc()" style="width:100%;">
                                <option value="none">None</option>
                                <option value="fairy">Fairy Dragon (Sonic Only)</option>
                                <option value="red">Red Fairy Dragon (BFO Harmony)</option>
                                <option value="blue">Blue Fairy Dragon (Vivace Harmony)</option>
                                <option value="green">Green Fairy Dragon (Harvest Harmony)</option>
                            </select>
                        </div>
                        <div id="pet-bonus-display" style="font-size:10px; color:var(--text-dim); text-align:right;"></div>
                    </details>
                </div>
            </div>
        </div>
    </div>

    <script>
    // --- Firebase Init ---
    const firebaseConfig = { apiKey: "AIzaSyC7A3Rzi-VddhqZiFGjHjjqBwCdX1ks6yM", authDomain: "mabinogi-tracker.firebaseapp.com", databaseURL: "https://mabinogi-tracker-default-rtdb.firebaseio.com", projectId: "mabinogi-tracker", storageBucket: "mabinogi-tracker.firebasestorage.app", appId: "1:267690802644:web:fccdd005d5c8990504ea41", measurementId: "G-VBDBKQ3M1B" };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

    let currentUser = null;
    let saveTimeout = null;
    let isLoading = true;
    let pendingReforges = {}; 
    let accReforgeCache = {}; 
    let skillRanks = { bfo: '1', vivace: '1', march: '1', harvest: '1', enduring: '1' }; 
    let setEffectCache = { bfo: {troub:false, seraph:false}, vivace: {troub:false, seraph:false}, march: {troub:false, seraph:false}, harvest: {troub:false, seraph:false}, enduring: {troub:false, seraph:false} };

    // --- Song Data ---
    // Expanded data with all rank values for BFO and Vivace, and March
    const songs = {
        'bfo': { 
            name: 'Battlefield Overture', 
            stats: [
                { name: 'Max Damage', 
                  base: { 
                      'N': 10, 'F': 10, 'E': 11, 'D': 12, 'C': 12, 'B': 13, 'A': 13, '9': 14, 
                      '8': 15, '7': 15, '6': 16, '5': 16, '4': 17, '3': 18, '2': 19, '1': 20 
                  }, 
                  suffix: '%' 
                },
                { name: 'Min Damage', 
                  base: { 
                      'N': 10, 'F': 10, 'E': 11, 'D': 11, 'C': 12, 'B': 12, 'A': 13, '9': 14, 
                      '8': 14, '7': 15, '6': 15, '5': 16, '4': 17, '3': 18, '2': 19, '1': 20 
                  }, 
                  suffix: '%' 
                },
                { name: 'Critical', 
                  base: { 
                      'N': 0, 'F': 1, 'E': 1, 'D': 2, 'C': 2, 'B': 3, 'A': 3, '9': 4, 
                      '8': 5, '7': 5, '6': 6, '5': 7, '4': 8, '3': 9, '2': 10, '1': 11 
                  }, 
                  suffix: '%' 
                }
            ],
            hasHarmony: true
        },
        'vivace': { 
            name: 'Vivace', 
            stats: [
                { name: 'Magic Attack', 
                  base: { 
                      'N': 10, 'F': 10, 'E': 10, 'D': 12, 'C': 12, 'B': 13, 'A': 13, '9': 14, 
                      '8': 15, '7': 15, '6': 16, '5': 16, '4': 17, '3': 18, '2': 19, '1': 20 
                  },
                  suffix: '%' 
                },
                { name: 'Alchemic Damage', 
                  base: { 
                      'N': 10, 'F': 10, 'E': 10, 'D': 12, 'C': 12, 'B': 13, 'A': 13, '9': 14, 
                      '8': 15, '7': 15, '6': 16, '5': 16, '4': 17, '3': 18, '2': 19, '1': 20 
                  },
                  suffix: '%' 
                },
                { name: 'Magic Cast Speed', 
                  base: { 
                      'N': 1, 'F': 2, 'E': 2, 'D': 3, 'C': 3, 'B': 4, 'A': 4, '9': 5, 
                      '8': 6, '7': 6, '6': 7, '5': 7, '4': 8, '3': 9, '2': 10, '1': 11 
                  },
                  suffix: '%', reforgeKey: 'reforge-cast-spd' 
                },
                { name: 'Attack Speed', 
                  base: { 
                      'N': 1, 'F': 1, 'E': 1, 'D': 2, 'C': 2, 'B': 3, 'A': 3, '9': 4, 
                      '8': 4, '7': 5, '6': 6, '5': 7, '4': 8, '3': 9, '2': 10, '1': 11 
                  },
                  suffix: '%', reforgeKey: 'reforge-atk-spd' 
                },
                { name: 'Alchemy Cast Speed', 
                  base: { 
                      'N': 1, 'F': 1, 'E': 2, 'D': 2, 'C': 3, 'B': 3, 'A': 4, '9': 5, 
                      '8': 5, '7': 6, '6': 6, '5': 7, '4': 8, '3': 9, '2': 10, '1': 11 
                  },
                  suffix: '%', reforgeKey: 'reforge-alch-spd' 
                }
            ],
            hasHarmony: true,
            reforges: [
                { id: 'reforge-cast-spd', label: 'Magic Cast Spd Reforge (Lvl)' },
                { id: 'reforge-atk-spd', label: 'Attack Spd Reforge (Lvl)' },
                { id: 'reforge-alch-spd', label: 'Alchemy Cast Spd Reforge (Lvl)' }
            ]
        },
        'march': { 
            name: 'March Song', 
            stats: [
                { name: 'Walk Speed', 
                  base: { 
                      'N': 1, 'F': 1, 'E': 1, 'D': 2, 'C': 2, 'B': 3, 'A': 3, '9': 5, 
                      '8': 6, '7': 6, '6': 7, '5': 7, '4': 8, '3': 8, '2': 10, '1': 12 
                  },
                  suffix: '%', reforgeKey: 'reforge-walk-spd' 
                },
                { name: 'Mount Speed', 
                  base: { 
                      'N': 1, 'F': 1, 'E': 2, 'D': 2, 'C': 3, 'B': 3, 'A': 4, '9': 5, 
                      '8': 5, '7': 6, '6': 6, '5': 7, '4': 7, '3': 8, '2': 8, '1': 9 
                  },
                  suffix: '%', reforgeKey: 'reforge-mount-spd' 
                }
            ],
            hasHarmony: false,
            reforges: [
                { id: 'reforge-walk-spd', label: 'Walk Speed Reforge (Lvl)' },
                { id: 'reforge-mount-spd', label: 'Mount Speed Reforge (Lvl)' }
            ]
        },
        'harvest': { 
            name: 'Harvest Song', 
            stats: [
                { name: 'Gathering Speed', 
                  base: {
                      'N': 0, 'F': 5, 'E': 6, 'D': 7, 'C': 8, 'B': 9, 'A': 10, '9': 11,
                      '8': 12, '7': 13, '6': 14, '5': 16, '4': 18, '3': 20, '2': 22, '1': 25
                  },
                  suffix: '%', reforgeKey: 'reforge-gather-spd' 
                }
            ],
            hasHarmony: true,
            reforges: [
                { id: 'reforge-gather-spd', label: 'Gathering Spd Reforge (Lvl)' }
            ]
        },
        'enduring': { 
            name: 'Enduring Melody', 
            stats: [
                { name: 'Def/M.Def', base: { 
                      'N': 1, 'F': 1, 'E': 1, 'D': 2, 'C': 2, 'B': 3, 'A': 4, '9': 5, 
                      '8': 6, '7': 7, '6': 7, '5': 8, '4': 9, '3': 9, '2': 10, '1': 11 
                  }, suffix: '' 
                },
                { name: 'Prot/M.Prot', base: { 
                      'N': 1, 'F': 1, 'E': 1, 'D': 1, 'C': 1, 'B': 1, 'A': 1, '9': 2, 
                      '8': 2, '7': 2, '6': 3, '5': 3, '4': 3, '3': 4, '2': 4, '1': 5 
                  }, suffix: '' 
                },
                { name: 'Recovery', base: {
                      'N': 100, 'F': 200, 'E': 230, 'D': 230, 'C': 260, 'B': 260, 'A': 275, '9': 290, 
                      '8': 305, '7': 320, '6': 335, '5': 350, '4': 365, '3': 380, '2': 395, '1': 410
                  }, suffix: '%' 
                }
            ],
            hasHarmony: false
        }
    };
    
    // Exact Lookup Tables
    const inspRatesNoLink = [5.07, 8.13, 11.00, 13.70, 16.24, 18.63, 20.89, 23.03, 25.05, 26.98, 28.80, 30.54, 32.19];
    const inspRatesWithLink = [5.07, 28.80, 43.04, 52.53, 59.31, 64.00, 68.36, 71.52, 74.11, 76.27, 78.09, 79.66, 100.00];

    // --- Auth Listener ---
    auth.onAuthStateChanged(user => {
        const uInfo = document.getElementById('user-info');
        const status = document.getElementById('connection-status');
        const uAvatar = document.getElementById('user-avatar');
        
        if (user) {
            currentUser = user;
            status.innerText = "Online";
            status.style.color = "var(--accent)";
            
            try {
                const cached = JSON.parse(localStorage.getItem('mabi_user_cache_' + user.uid) || '{}');
                uInfo.innerText = cached.username || user.email;
                if(cached.avatar) uAvatar.style.backgroundImage = `url('${cached.avatar}')`;
            } catch(e) {}
            
            db.ref(`users/${user.uid}/profile`).on('value', snap => {
                const profile = snap.val();
                if(profile) {
                    if(profile.username) uInfo.innerText = profile.username;
                    if(profile.avatar) uAvatar.style.backgroundImage = `url('${profile.avatar}')`;
                    localStorage.setItem('mabi_user_cache_' + user.uid, JSON.stringify(profile));
                }
            });

            db.ref('users/' + user.uid + '/music_calc').once('value', snap => {
                if(snap.val()) applyData(snap.val());
                isLoading = false;
                // Important: Call updateUI on load to populate inputs
                updateUI();
            });
        } else {
            currentUser = null;
            uInfo.innerText = "Guest";
            status.innerText = "Local Mode";
            status.style.color = "var(--text-dim)";
            
            const local = localStorage.getItem('mabi_music_calc');
            if(local) applyData(JSON.parse(local));
            isLoading = false;
            updateUI();
        }
    });

    function getVal(id) {
        const el = document.getElementById(id);
        return el ? (parseFloat(el.value) || 0) : 0;
    }

    function toggleSets(set) {
        const songKey = document.getElementById('active-song').value;
        const currentSets = setEffectCache[songKey] || { troub: false, seraph: false };

        if(set === 'troub') {
            currentSets.troub = document.getElementById('set-troubadour').checked;
            if(currentSets.troub) {
                 currentSets.seraph = false;
                 document.getElementById('set-seraphic').checked = false;
            }
        } else {
            currentSets.seraph = document.getElementById('set-seraphic').checked;
            if(currentSets.seraph) {
                 currentSets.troub = false;
                 document.getElementById('set-troubadour').checked = false;
            }
        }
        setEffectCache[songKey] = currentSets;
        calc();
    }
    
    function updateAcc(val) {
        const songKey = document.getElementById('active-song').value;
        accReforgeCache[songKey] = parseFloat(val) || 0;
        calc();
    }

    function updateUI() {
        const songKey = document.getElementById('active-song').value;
        const songData = songs[songKey];
        
        document.getElementById('res-label').innerText = `FINAL ${songData.name.toUpperCase()}`;
        
        // Update Specific Reforges UI
        const container = document.getElementById('specific-reforge-area');
        container.innerHTML = '';
        
        if (songData.reforges) {
            songData.reforges.forEach(r => {
                const row = document.createElement('div');
                row.className = 'stat-input-row';
                // Try to get saved value from pending cache
                const savedVal = pendingReforges[r.id] || 0;
                
                row.innerHTML = `
                    <span class="stat-name" style="color:var(--accent);">${r.label}</span>
                    <input type="number" id="${r.id}" class="input-dark stat-input" value="${savedVal}" placeholder="Lvl" oninput="calc()">
                `;
                container.appendChild(row);
            });
            const hint = document.createElement('div');
            hint.style.cssText = "font-size:10px; color:var(--text-dim);";
            hint.innerText = "Adds to Base Effect before multiplication. (1 Lvl = 1%)";
            container.appendChild(hint);
        } else {
            container.innerHTML = '<div style="font-size:11px;color:var(--text-dim);text-align:center;">No specific reforges for this skill</div>';
        }
        
        // Toggle MK Insp (Acc) Input
        const mkAccRow = document.getElementById('mk-insp-acc-row');
        if (['bfo', 'vivace'].includes(songKey)) {
             mkAccRow.style.display = 'flex';
        } else {
             mkAccRow.style.display = 'none';
        }
        
        // Toggle Seraphic Set Visibility
        const seraphicContainer = document.getElementById('seraphic-set-container');
        if (songKey === 'bfo') {
            seraphicContainer.style.display = 'flex';
        } else {
            seraphicContainer.style.display = 'none';
        }
        
        // Update Accessory Input from Cache
        const accInp = document.getElementById('reforge-mk-insp-acc');
        if (accInp) {
             accInp.value = accReforgeCache[songKey] || 0;
        }
        
        // Restore Skill Rank per Song
        const skillDropdown = document.getElementById('skill-rank');
        if(skillRanks[songKey]) {
            skillDropdown.value = skillRanks[songKey];
        } else {
            skillDropdown.value = "1"; // Default
        }
        
        // Restore Set Effects per Song
        const currentSets = setEffectCache[songKey] || { troub: false, seraph: false };
        document.getElementById('set-troubadour').checked = currentSets.troub;
        document.getElementById('set-seraphic').checked = currentSets.seraph;
        
        // Toggle Harvest Party Input
        const partyContainer = document.getElementById('harvest-party-container');
        if(songKey === 'harvest') {
            partyContainer.style.display = 'block';
        } else {
            partyContainer.style.display = 'none';
        }
        
        calc();
    }

    function calc() {
        const songKey = document.getElementById('active-song').value;
        const songData = songs[songKey];
        
        // Save current rank to cache
        const currentRank = document.getElementById('skill-rank').value;
        skillRanks[songKey] = currentRank;

        // 2. Sum of Music Buff Effect Bonuses
        const enchants = getVal('ench-total');
        const upgrades = getVal('upg-total');
        const tiara = getVal('tiara-val');
        const homestead = getVal('homestead-val');
        const reforgePI = getVal('reforge-pi'); 
        
        const rankPI = parseFloat(document.getElementById('rank-pi').value);
        const rankSong = parseFloat(document.getElementById('rank-song').value);
        const gm = document.getElementById('gm-bard').checked ? 5 : 0;
        const potion = document.getElementById('buff-pot').checked ? 2 : 0;
        const saint = document.getElementById('link-bonus').checked ? 3 : 0;
        const t1 = getVal('title-1');
        const t2 = getVal('title-2');
        
        const petType = document.getElementById('pet-select').value;
        let petSonicBonus = 0;
        let petHarmonyBonus = 0;
        let petStatusText = "";
        
        if (petType !== 'none') {
            petSonicBonus = 3; 
            petStatusText = "+3 Sonic Wave";
        }
        if (petType === 'red' && songKey === 'bfo') petHarmonyBonus = 2;
        else if (petType === 'blue' && songKey === 'vivace') petHarmonyBonus = 2;
        else if (petType === 'green' && songKey === 'harvest') petHarmonyBonus = 2;

        if (petHarmonyBonus > 0) petStatusText += ", +2 Harmony";
        document.getElementById('pet-bonus-display').innerText = petStatusText;
        
        // Sets (Now read from DOM since updateUI sets them)
        const troubadourCheck = document.getElementById('set-troubadour').checked;
        const seraphicCheck = document.getElementById('set-seraphic').checked;
        
        // "Max Rule": Seraphic is +5, Troubadour is +3. If BFO and both somehow active (UI prevents this usually), take max.
        // But since Seraphic only applies to BFO, logic simplifies:
        // Troubadour applies to ALL. Seraphic only BFO.
        // If BFO: Max(Troub ? 3 : 0, Seraph ? 5 : 0).
        // If Other: Troub ? 3 : 0.
        
        let setBonusVal = 0;
        if (songKey === 'bfo') {
            const tVal = troubadourCheck ? 3 : 0;
            const sVal = seraphicCheck ? 5 : 0;
            setBonusVal = Math.max(tVal, sVal);
        } else {
            setBonusVal = troubadourCheck ? 3 : 0;
        }

        const buffBonusSum = enchants + upgrades + setBonusVal + tiara + homestead + 
                             reforgePI + rankPI + rankSong + gm + potion + saint + petSonicBonus + 
                             t1 + t2;

        const multiplierA = 1 + (buffBonusSum * 0.01);

        // 3. Performance Multiplier (Multiplier B)
        const perfSelect = document.getElementById('perf-type').value; 
        let perfQuality = 1.0;
        let reforgeMK = 0;

        if (perfSelect === '1.0') {
            perfQuality = 1.0; reforgeMK = getVal('reforge-mk-norm');
        } else if (perfSelect === '1.1') {
            perfQuality = 1.1; reforgeMK = getVal('reforge-mk-exc');
        } else if (perfSelect === '1.3') {
            perfQuality = 1.3; 
            reforgeMK = getVal('reforge-mk-insp');
            
            // Add Accessory Bonus for current song
            reforgeMK += (accReforgeCache[songKey] || 0);
        }

        const multiplierB = perfQuality + (reforgeMK * 0.01);
        const itemGrade = getVal('item-grade');
        const specialUpgrade = getVal('special-upgrade');
        const finalMultiplier = 1 + (itemGrade * 0.01) + (specialUpgrade * 0.01);
        
        // --- Inspiring Chance Calculation ---
        const link10 = document.getElementById('link-saint-10').checked;
        const inspRefLevel = Math.min(Math.max(Math.floor(getVal('reforge-insp-rate')), 0), 12);
        
        let chance = 0;
        if (link10) {
            chance = inspRatesWithLink[inspRefLevel] || 100.00;
        } else {
            chance = inspRatesNoLink[inspRefLevel] || 32.19;
        }
        
        document.getElementById('res-insp-chance').innerText = chance.toFixed(2) + '%';

        // --- RENDER RESULTS ---
        const resultContainer = document.getElementById('result-container');
        resultContainer.innerHTML = '';

        songData.stats.forEach(stat => {
            let specificBonus = 0;
            if (stat.reforgeKey) {
                specificBonus = getVal(stat.reforgeKey);
            }
            
            // --- UPDATED BASE LOOKUP ---
            // Try to find the base for the specific rank. Fallback to '1' if not defined yet for this song.
            let rawBase = 0;
            if (typeof stat.base === 'object') {
                rawBase = stat.base[currentRank] !== undefined ? stat.base[currentRank] : stat.base['1'];
            } else {
                // Legacy support just in case
                rawBase = stat.base;
            }

            // Base + Specific Reforge
            const modifiedBase = rawBase + specificBonus;
            
            // Calculate components
            const mainTerm = multiplierA * modifiedBase * multiplierB;
            
            // Harmony is applied to Base (Modified Base)
            const harmonyTerm = (petHarmonyBonus * 0.01) * modifiedBase;
            
            // Sum and apply final multipliers
            let total = (mainTerm + harmonyTerm) * finalMultiplier;
            
            // Harvest Song Party Bonus (Added at the very end)
            if (songKey === 'harvest' && stat.name === 'Gathering Speed') {
                const partySize = Math.max(1, parseInt(document.getElementById('party-members').value) || 1);
                // 3% per party member after the first one
                const partyBonus = (partySize - 1) * 3;
                total += partyBonus;
            }
            
            const div = document.createElement('div');
            div.className = 'res-row';
            div.innerHTML = `
                <span class="res-name">${stat.name}</span>
                <span class="res-val">${total.toFixed(2)}${stat.suffix}</span>
            `;
            resultContainer.appendChild(div);
        });

        document.getElementById('res-buff-stat').innerText = buffBonusSum;
        
        saveData();
    }

    // --- DATA PERSISTENCE ---
    function applyData(data) {
        if(!data) return;
        setVal('active-song', data.activeSong);
        setVal('perf-type', data.perfType);
        setVal('reforge-mk-norm', data.mkNorm);
        setVal('reforge-mk-exc', data.mkExc);
        setVal('reforge-mk-insp', data.mkInsp);
        setVal('reforge-mk-insp-acc', data.mkInspAcc); 
        
        if(data.reforges) {
            pendingReforges = data.reforges;
        }
        
        if(data.accReforges) {
             accReforgeCache = data.accReforges;
        }
        
        if(data.skillRanks) {
             skillRanks = data.skillRanks;
        }
        
        if(data.setEffects) {
             setEffectCache = data.setEffects;
        }

        setVal('rank-pi', data.rankPi);
        setVal('rank-song', data.rankSong);
        setCheck('gm-bard', data.gmBard);
        setVal('ench-total', data.enchTotal);
        setVal('upg-total', data.upgTotal);
        // Set Checkboxes handled in updateUI via setEffectCache
        
        setVal('tiara-val', data.tiara);
        setVal('reforge-pi', data.reforgePi);
        setVal('title-1', data.title1);
        setVal('title-2', data.title2);
        setCheck('buff-pot', data.buffPot);
        setCheck('link-bonus', data.linkBonus);
        setVal('homestead-val', data.homestead);
        
        if(data.petSelect) setVal('pet-select', data.petSelect);
        else if(data.petSonic) setVal('pet-select', 'fairy');
        
        setVal('item-grade', data.itemGrade);
        setVal('special-upgrade', data.specialUpgrade);
        
        setCheck('link-saint-10', data.linkSaint10);
        setVal('reforge-insp-rate', data.reforgeInspRate);
        setVal('party-members', data.partyMembers); 
        
        updateUI(); 
    }

    function saveData() {
        if(isLoading) return;
        
        // Capture active dynamic input values into cache object
        const container = document.getElementById('specific-reforge-area');
        if (container) {
             const inputs = container.querySelectorAll('input');
             inputs.forEach(inp => {
                 pendingReforges[inp.id] = parseFloat(inp.value) || 0;
             });
        }

        const data = {
            activeSong: getValStr('active-song'),
            perfType: getValStr('perf-type'),
            mkNorm: getVal('reforge-mk-norm'),
            mkExc: getVal('reforge-mk-exc'),
            mkInsp: getVal('reforge-mk-insp'),
            mkInspAcc: getVal('reforge-mk-insp-acc'), 
            reforges: pendingReforges,
            accReforges: accReforgeCache, 
            skillRanks: skillRanks,
            setEffects: setEffectCache,
            rankPi: getValStr('rank-pi'),
            rankSong: getValStr('rank-song'),
            gmBard: getCheck('gm-bard'),
            enchTotal: getVal('ench-total'),
            upgTotal: getVal('upg-total'),
            // Set Troub/Seraph checks are dynamic now, saving cache instead
            tiara: getVal('tiara-val'),
            reforgePi: getVal('reforge-pi'),
            title1: getVal('title-1'),
            title2: getVal('title-2'),
            buffPot: getCheck('buff-pot'),
            linkBonus: getCheck('link-bonus'),
            homestead: getVal('homestead-val'),
            petSelect: getValStr('pet-select'),
            itemGrade: getVal('item-grade'),
            specialUpgrade: getVal('special-upgrade'),
            linkSaint10: getCheck('link-saint-10'),
            reforgeInspRate: getVal('reforge-insp-rate'),
            partyMembers: getVal('party-members') 
        };
        
        localStorage.setItem('mabi_music_calc', JSON.stringify(data));
        if(currentUser) {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                db.ref('users/' + currentUser.uid + '/music_calc').update(data);
            }, 1000);
        }
    }
    
    function setVal(id, v) { if(v !== undefined && document.getElementById(id)) document.getElementById(id).value = v; }
    function setCheck(id, v) { if(v !== undefined && document.getElementById(id)) document.getElementById(id).checked = v; }
    function getValStr(id) { return document.getElementById(id) ? document.getElementById(id).value : ''; }
    function getCheck(id) { return document.getElementById(id) ? document.getElementById(id).checked : false; }

    window.toggleSidebar = (side) => {
        const left = document.getElementById('left-panel');
        const right = document.getElementById('right-panel');
        const backdrop = document.getElementById('mobile-backdrop');
        if (side === 'left') { 
            const isActive = left.classList.contains('active');
            closeSidebars(); 
            if (!isActive) { left.classList.add('active'); backdrop.classList.add('active'); }
        } 
        if (side === 'right') { 
            const isActive = right.classList.contains('active');
            closeSidebars(); 
            if (!isActive) { right.classList.add('active'); backdrop.classList.add('active'); }
        } 
    };
    window.closeSidebars = () => {
        document.getElementById('left-panel').classList.remove('active');
        document.getElementById('right-panel').classList.remove('active');
        document.getElementById('mobile-backdrop').classList.remove('active');
    };

    // Init will be triggered by auth listener or fallback
    </script>
</body>
</html>
