<!DOCTYPE html>
<html lang="en">
<head>

    <!-- PWA Manifest & Settings -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#050506">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // navigator.serviceWorker.register('sw.js').catch(err => console.log('Service Worker failed', err));
            });
        }
    </script>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mabi Tools</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* V2.7 Theme */
            --bg: #09090b;
            --sidebar-bg: #121214;
            --card-bg: #18181b;
            
            /* Tool Theme: Sky Blue */
            --accent: #38bdf8;
            --accent-dim: rgba(56, 189, 248, 0.1);
            
            --border: #27272a;
            --text-main: #e4e4e7;
            --text-dim: #a1a1aa;
            --danger: #ef4444;
            --success: #00ff88;
            --warning: #eab308;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text-main);
            margin: 0;
            font-size: 13px;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Layout */
        .interface-container { display: flex; flex-direction: column; height: 100%; width: 100%; }
        .header-bar { background: var(--sidebar-bg); border-bottom: 1px solid var(--border); padding: 10px 20px; flex-shrink: 0; }
        .title-section { display: flex; justify-content: space-between; align-items: center; }
        .main-title { font-size: 16px; font-weight: 700; color: #fff; letter-spacing: 0.5px; }

        .content-grid { display: grid; grid-template-columns: 280px 1fr 320px; flex-grow: 1; overflow: hidden; }
        .panel { background: var(--bg); display: flex; flex-direction: column; border-right: 1px solid var(--border); overflow-y: auto; }
        .panel:last-child { border-right: none; }
        .center-panel { background: #0c0c0e; display: flex; flex-direction: column; padding: 20px; align-items: center; }

        /* Components */
        .panel-label { font-size: 11px; font-weight: 600; color: var(--text-dim); margin-bottom: 8px; display: block; text-transform: uppercase; }
        .config-section { padding: 20px; border-bottom: 1px solid var(--border); }
        
        .input-dark { background: var(--card-bg); border: 1px solid var(--border); color: #fff; font-family: 'JetBrains Mono', monospace; font-size: 13px; padding: 8px; border-radius: 6px; width: 100%; transition: border-color 0.2s; }
        .input-dark:focus { border-color: var(--accent); }
        select.input-dark { -webkit-appearance: none; font-family: 'Inter', sans-serif; cursor: pointer; }
        textarea.input-dark { resize: vertical; min-height: 100px; font-family: 'JetBrains Mono', monospace; font-size: 11px; }
        
        .hub-btn { 
            color: var(--text-dim); text-decoration: none; font-weight: 600; font-size: 12px; 
            padding: 8px 12px; border-radius: 6px; transition: 0.2s; 
            border: 1px solid transparent; background: transparent; cursor: pointer; text-align: left; width: 100%;
            display: flex; align-items: center; gap: 10px;
        }
        .hub-btn:hover { color: #fff; background: var(--border); }
        .hub-btn.active { color: var(--accent); background: var(--accent-dim); border-color: var(--accent); }
        
        /* Tool Icon */
        .tool-icon { width: 24px; height: 24px; border-radius: 4px; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; font-size: 12px; }
        
        /* Calculator Inputs */
        .calc-box {
            background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px;
            padding: 30px; width: 100%; max-width: 600px;
        }
        
        .calc-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .calc-group { display: flex; flex-direction: column; gap: 5px; }
        .calc-label { font-size: 11px; font-weight: 700; color: var(--text-dim); text-transform: uppercase; }
        
        .result-box {
            background: var(--bg); border: 1px solid var(--border); border-radius: 8px;
            padding: 20px; margin-top: 20px; text-align: center;
        }
        .result-val { font-family: 'JetBrains Mono', monospace; font-size: 24px; font-weight: 700; color: var(--accent); }
        .result-sub { font-size: 11px; color: var(--text-dim); margin-top: 5px; }

        /* Multiplier List Item */
        .mult-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px; border: 1px solid var(--border); border-radius: 6px;
            margin-bottom: 8px; background: var(--card-bg); transition: 0.2s;
        }
        .mult-item:hover { border-color: #555; }
        .mult-info { display: flex; align-items: center; gap: 10px; }
        .mult-val { font-family: 'JetBrains Mono', monospace; color: var(--accent); font-size: 12px; font-weight: 700; }
        
        /* Toggles */
        .toggle-switch { width: 36px; height: 20px; background: var(--border); border-radius: 99px; position: relative; transition: 0.2s; flex-shrink: 0; cursor: pointer; }
        .toggle-switch::after { content: ''; position: absolute; top: 2px; left: 2px; width: 16px; height: 16px; background: #fff; border-radius: 50%; transition: 0.2s; }
        input:checked + .toggle-switch { background: var(--accent); }
        input:checked + .toggle-switch::after { transform: translateX(16px); }
        .toggle-input { display: none; }
        
        /* Small Buttons */
        .btn-mini { width: 24px; height: 24px; border: none; background: transparent; color: var(--text-dim); cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; border-radius: 4px; }
        .btn-mini:hover { background: var(--border); color: #fff; }
        .btn-mini.del:hover { background: rgba(239,68,68,0.2); color: var(--danger); }

        /* Dropdown Group Styling */
        .mult-group-container {
            margin-bottom: 12px;
        }
        .mult-group-label {
            font-size: 10px; color: var(--text-dim); font-weight: 700; uppercase; margin-bottom: 4px;
        }

        /* Move Speed Specific */
        .group-result { margin-top: 10px; font-family: 'JetBrains Mono'; font-size: 11px; text-align: right; color: var(--text-dim); }
        .group-result.winner { color: var(--success); font-weight: 700; }
        .section-note { font-size: 11px; color: var(--text-dim); font-weight: 400; display: block; margin-top: 2px; }
        .input-group-x { display: flex; align-items: center; gap: 5px; }
        .btn-x { 
            width: 30px; height: 35px; background: var(--card-bg); border: 1px solid var(--border); 
            color: var(--text-dim); border-radius: 6px; cursor: pointer; display: flex; 
            align-items: center; justify-content: center; transition: 0.2s; flex-shrink: 0;
        }
        .btn-x:hover { color: var(--danger); border-color: var(--danger); background: rgba(239, 68, 68, 0.1); }
        .toggle-row {
            display: flex; align-items: center; justify-content: space-between;
            background: var(--bg); padding: 8px 10px; border-radius: 6px;
            border: 1px solid var(--border); height: 35px;
        }
        .form-group-disabled { opacity: 0.3; pointer-events: none; }

        /* Mobile */
        .mobile-nav { display: none; }
        .mobile-backdrop { display: none; }
        .drawer-header { display: none; } 
        .mobile-only { display: none; }
        
        /* Artifact Row */
        .artifact-row {
            display: flex; justify-content: space-between; margin-bottom: 5px;
            font-size: 12px;
        }
        .artifact-name { color: var(--text-dim); }
        .artifact-val { color: #fff; font-family: 'JetBrains Mono', monospace; }

        @media (max-width: 1000px) {
            .mobile-only { display: block; }
            .content-grid { display: block; height: calc(100dvh - 50px); }
            .header-bar { display: none; }

            .mobile-nav { 
                display: flex; justify-content: space-between; align-items: center; 
                padding: 10px 15px; background: var(--sidebar-bg); border-bottom: 1px solid var(--border); 
                height: 50px; z-index: 50; flex-shrink: 0;
            }
            .nav-trigger { background: transparent; border: 1px solid var(--border); color: var(--text-main); padding: 6px 12px; border-radius: 6px; font-size: 14px; cursor: pointer; }
            
            .left-panel, .right-panel {
                position: fixed; top: 0; bottom: 0; width: 300px; max-width: 85%; z-index: 1001; 
                box-shadow: 0 0 50px rgba(0,0,0,0.8); 
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.3s;
                visibility: hidden; 
            }
            .left-panel { left: 0; transform: translateX(-100%); border-right: 1px solid var(--border); }
            .right-panel { right: 0; transform: translateX(100%); border-left: 1px solid var(--border); }
            .left-panel.active, .right-panel.active { transform: translateX(0); visibility: visible; }
            
            .center-panel { height: 100%; width: 100%; border: none; padding: 15px; }
            .mobile-backdrop { display: block; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s; backdrop-filter: blur(4px); }
            .mobile-backdrop.active { opacity: 1; pointer-events: all; }
            
            .drawer-header { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid var(--border); background: var(--sidebar-bg); }
            .drawer-title { font-weight: 700; color: #fff; }
            .drawer-close { background: none; border: none; color: var(--text-dim); font-size: 20px; padding: 0 5px; cursor: pointer; }

            .user-profile-box { display: flex; align-items: center; gap: 12px; padding: 15px; border-bottom: 1px solid var(--border); }
            .user-avatar-mobile { width: 40px; height: 40px; border-radius: 50%; background-color: var(--card-bg); border: 1px solid var(--border); background-size: cover; background-position: center; flex-shrink: 0; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23a1a1aa'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E"); }
        }
    </style>
</head>
<body>

    <!-- Mobile Navigation -->
    <div class="mobile-nav">
        <div style="display:flex; gap:12px; align-items:center;">
             <button class="nav-trigger" onclick="window.location.href='index.html'" style="padding: 6px 10px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
            </button>
            <button class="nav-trigger" onclick="toggleSidebar('left')">☰ Tools</button>
        </div>
        <span style="font-weight:700; color:#fff;">Calculators</span>
        <button class="nav-trigger" onclick="toggleSidebar('right')">Rules ⚙</button>
    </div>

    <div class="mobile-backdrop" id="mobile-backdrop" onclick="closeSidebars()"></div>

    <div class="interface-container">
        <!-- Global Navigation Bar -->
        <script src="nav.js" defer></script>
            <global-nav></global-nav>
        <!-- end of global nav bar -->
        <!-- Desktop Header -->
        <div class="header-bar">
            <div class="title-section">
                <div style="display:flex; align-items:center;">
                    <span class="main-title">MABI CALCULATORS</span>
                </div>
                
                <user-header></user-header>
            
            </div>
        </div>

        <div class="content-grid">
            <!-- LEFT PANEL: Tool Selector -->
            <div class="panel left-panel" id="left-panel">
                <div class="drawer-header">
                    <span class="drawer-title">Toolbox</span>
                    <button class="drawer-close" onclick="closeSidebars()">×</button>
                </div>

                <div class="user-profile-box mobile-only">
                    <div id="mobile-user-avatar" class="user-avatar-mobile"></div>
                    <div style="flex-grow:1; min-width:0;">
                        <div id="mobile-user-info" class="user-info-text-mobile">Guest</div>
                        <div id="mobile-connection-status" class="user-status-mobile">Local Mode</div>
                    </div>
                </div>

                <div class="config-section" style="border-bottom:none;">
                    <label class="panel-label">Leveling</label>
                    <button id="btn-char-exp" class="hub-btn active" onclick="setTool('char-exp')">
                        <div class="tool-icon">Lv</div> Character EXP
                    </button>
                    <button id="btn-explore-exp" class="hub-btn" onclick="setTool('explore-exp')">
                        <div class="tool-icon">Ex</div> Exploration EXP
                    </button>
                    
                    <label class="panel-label" style="margin-top:20px;">Stats</label>
                    <button id="btn-move-speed" class="hub-btn" onclick="setTool('move-speed')">
                        <div class="tool-icon">Ms</div> Move Speed
                    </button>

                    <label class="panel-label" style="margin-top:20px;">Growth</label>
                    <button class="hub-btn" onclick="setTool('ego-feed')" style="opacity:0.5;">
                        <div class="tool-icon">Eg</div> Spirit Weapon (WIP)
                    </button>
                    <button class="hub-btn" onclick="setTool('erg-break')" style="opacity:0.5;">
                        <div class="tool-icon">Er</div> Erg Breaker (WIP)
                    </button>
                </div>
            </div>

            <!-- CENTER PANEL: Calculator Workspace -->
            <div class="panel center-panel">
                
                <!-- Character EXP Calculator -->
                <div id="tool-char-exp" class="calc-box">
                    <h2 id="calc-title" style="font-size:20px; font-weight:700; color:#fff; margin-bottom:20px; border-bottom:1px solid var(--border); padding-bottom:15px;">Character Level</h2>
                    
                    <div class="calc-group" style="margin-bottom:20px;">
                        <label class="calc-label">Current Total Accumulated EXP</label>
                        <input type="text" id="cur-total-exp" class="input-dark" placeholder="e.g. 10,000,000" oninput="calculateExp()" onchange="formatInput(this)" style="font-size:14px; font-family:'JetBrains Mono';">
                    </div>

                    <div class="calc-row" style="background:var(--bg); border:1px solid var(--border); border-radius:8px; padding:15px; margin-bottom:20px;">
                        <div class="calc-group">
                            <label class="calc-label" style="opacity:0.7;">Current Level</label>
                            <input type="number" id="disp-lvl" class="input-dark" value="1" min="1" max="200" style="background:transparent; border:none; font-size:18px; font-weight:700; color:#fff; padding:0;" onchange="updateTotalFromLevel(this.value)">
                        </div>
                        <div class="calc-group">
                            <label class="calc-label" style="opacity:0.7;">Current %</label>
                            <div id="disp-pct" style="font-size:18px; font-weight:700; color:#fff;">0.00%</div>
                        </div>
                    </div>
                    
                    <!-- Exploration Settings (Hidden by default) -->
                    <div id="expl-settings" class="calc-row" style="display:none; background:var(--bg); border:1px solid var(--border); border-radius:8px; padding:15px; margin-bottom:20px;">
                        <div class="calc-group">
                            <label class="calc-label" style="opacity:0.7;">Exploration Mastery</label>
                            <select id="expl-mastery" class="input-dark" onchange="calculateExp()">
                                <option value="N" selected>Rank N/F (0%)</option>
                                <option value="E">Rank E (10%)</option>
                                <option value="D">Rank D (15%)</option>
                                <option value="C">Rank C (20%)</option>
                                <option value="B">Rank B (25%)</option>
                                <option value="A">Rank A (30%)</option>
                                <option value="9">Rank 9 (35%)</option>
                                <option value="8">Rank 8 (40%)</option>
                                <option value="7">Rank 7 (45%)</option>
                                <option value="6">Rank 6 (50%)</option>
                                <option value="5">Rank 5 (55%)</option>
                                <option value="4">Rank 4 (60%)</option>
                                <option value="3">Rank 3 (65%)</option>
                                <option value="2">Rank 2 (70%)</option>
                                <option value="1">Rank 1 (80%)</option>
                            </select>
                        </div>
                        
                        <div class="calc-group">
                            <label class="calc-label" style="opacity:0.7;">Fynn Bell Bonus (%)</label>
                            <input type="number" id="fynn-bell" class="input-dark" value="0" placeholder="Required for crafting" oninput="calculateExp()">
                        </div>

                        <div class="calc-group" style="grid-column: 1 / -1;">
                            <label class="calc-label" style="color:var(--accent);">Fynn Crafting Base Exp</label>
                            <input type="text" id="custom-base-exp" class="input-dark" placeholder="Item Base EXP (e.g. 5000)" oninput="calculateExp()" onchange="formatInput(this)">
                        </div>
                    </div>

                    <div class="calc-group" style="margin-bottom:20px;">
                        <label class="calc-label" style="color:var(--accent);">Target Level</label>
                        <input type="number" id="tgt-lvl" class="input-dark" value="200" min="1" max="200" style="font-size:16px; font-weight:700;" oninput="calculateExp()">
                    </div>

                    <div class="result-box">
                        <div class="calc-label">EXP Needed</div>
                        <div id="res-exp" class="result-val">0</div>
                        <div id="res-sub" class="result-sub">For Target Level</div>
                    </div>
                </div>

                <!-- MOVE SPEED CALCULATOR -->
                <div id="tool-move-speed" class="calc-box" style="display:none; max-width:800px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid var(--border); padding-bottom:15px;">
                        <span style="font-size:20px; font-weight:700; color:#fff;">Move Speed</span>
                        <div style="text-align:right;">
                            <span class="calc-label">Total</span>
                            <div id="ms-final-speed" style="font-family:'JetBrains Mono'; font-size:20px; color:var(--accent); font-weight:700;">116.0%</div>
                        </div>
                    </div>

                    <div class="calc-row">
                        <!-- Group 1 -->
                        <div class="calc-group">
                            <label class="calc-label">Group 1 (Status) <span class="section-note" style="display:inline;">Highest Only</span></label>
                            <div style="background:rgba(0,0,0,0.2); border:1px dashed var(--border); border-radius:8px; padding:15px;">
                                <div class="calc-group" style="margin-bottom:8px;">
                                    <label class="calc-label" style="text-transform:none;opacity:0.8;">Wave Sweeper</label>
                                    <div class="input-group-x">
                                        <select id="ms-totem" class="input-dark ms-trigger"><option value="0">None</option></select>
                                        <button class="btn-x" onclick="resetMsInput('ms-totem')">×</button>
                                    </div>
                                </div>
                                <div class="calc-group" style="margin-bottom:8px;">
                                    <label class="calc-label" style="text-transform:none;opacity:0.8;">Shoe Reforge</label>
                                    <div class="input-group-x">
                                        <select id="ms-reforge" class="input-dark ms-trigger"><option value="0">None</option></select>
                                        <button class="btn-x" onclick="resetMsInput('ms-reforge')">×</button>
                                    </div>
                                </div>
                                <div class="calc-group" style="margin-bottom:8px;">
                                    <label class="calc-label" style="text-transform:none;opacity:0.8;">Demi-God (40%)</label>
                                    <label class="toggle-row">
                                        <span id="lbl-ms-demigod">Inactive</span>
                                        <input type="checkbox" id="ms-demigod" class="toggle-input ms-trigger">
                                        <div class="toggle-switch"></div>
                                    </label>
                                </div>
                                <div class="calc-group" style="margin-bottom:8px;">
                                    <label class="calc-label" style="text-transform:none;opacity:0.8;">Title (%)</label>
                                    <div class="input-group-x">
                                        <input type="number" id="ms-title" class="input-dark ms-trigger" placeholder="0" value="0">
                                        <button class="btn-x" onclick="resetMsInput('ms-title')">×</button>
                                    </div>
                                </div>
                                <div class="calc-group">
                                    <label class="calc-label" style="text-transform:none;opacity:0.8;">March Song (%)</label>
                                    <div class="input-group-x">
                                        <input type="number" id="ms-march" class="input-dark ms-trigger" placeholder="0" value="0">
                                        <button class="btn-x" onclick="resetMsInput('ms-march')">×</button>
                                    </div>
                                </div>
                                <div id="ms-g1-max" class="group-result">Max: 0%</div>
                            </div>
                        </div>

                        <!-- Group 2 -->
                        <div class="calc-group">
                            <label class="calc-label">Group 2 (Active) <span class="section-note" style="display:inline;">Highest Only</span></label>
                            <div style="background:rgba(0,0,0,0.2); border:1px dashed var(--border); border-radius:8px; padding:15px;">
                                <div class="calc-group" style="margin-bottom:8px;">
                                    <label class="calc-label" style="text-transform:none;opacity:0.8;">Pet/Partner (55%)</label>
                                    <label class="toggle-row">
                                        <span id="lbl-ms-pet-buff">Inactive</span>
                                        <input type="checkbox" id="ms-pet-buff" class="toggle-input ms-trigger">
                                        <div class="toggle-switch"></div>
                                    </label>
                                </div>
                                <div class="calc-group" style="margin-bottom:8px;">
                                    <label class="calc-label" style="text-transform:none;opacity:0.8;">Potion</label>
                                    <div class="input-group-x">
                                        <select id="ms-potion" class="input-dark ms-trigger">
                                            <option value="0">None</option>
                                            <option value="30">30%</option>
                                            <option value="40">40%</option>
                                        </select>
                                        <button class="btn-x" onclick="resetMsInput('ms-potion')">×</button>
                                    </div>
                                </div>
                                <div class="calc-group" style="margin-bottom:8px;">
                                    <label class="calc-label" style="text-transform:none;opacity:0.8;">Shadow Cloak (100%)</label>
                                    <label class="toggle-row">
                                        <span id="lbl-ms-cloak">Inactive</span>
                                        <input type="checkbox" id="ms-cloak" class="toggle-input ms-trigger">
                                        <div class="toggle-switch"></div>
                                    </label>
                                </div>
                                <div class="calc-group" style="margin-bottom:8px;">
                                    <label class="calc-label" style="text-transform:none;opacity:0.8;">Shylock's Step (100%)</label>
                                    <label class="toggle-row">
                                        <span id="lbl-ms-shylock">Inactive</span>
                                        <input type="checkbox" id="ms-shylock" class="toggle-input ms-trigger">
                                        <div class="toggle-switch"></div>
                                    </label>
                                </div>
                                <div class="calc-group form-group-disabled" id="ms-alpaca-wrap" style="margin-bottom:8px;">
                                    <label class="calc-label" style="text-transform:none;opacity:0.8;">Alpaca Robe (20%)</label>
                                    <label class="toggle-row">
                                        <span id="lbl-ms-alpaca">Unequipped</span>
                                        <input type="checkbox" id="ms-alpaca" class="toggle-input ms-trigger">
                                        <div class="toggle-switch"></div>
                                    </label>
                                </div>
                                <div class="calc-group form-group-disabled" id="ms-comm-reforge-wrap">
                                    <label class="calc-label" style="text-transform:none;opacity:0.8;">Commerce Reforge</label>
                                    <div class="input-group-x">
                                        <select id="ms-commerce-reforge" class="input-dark ms-trigger"><option value="0">None</option></select>
                                        <button class="btn-x" onclick="resetMsInput('ms-commerce-reforge')">×</button>
                                    </div>
                                </div>
                                <div id="ms-g2-max" class="group-result">Max: 0%</div>
                            </div>
                        </div>
                    </div>

                    <!-- Extra Additives -->
                    <div class="calc-group">
                        <label class="calc-label">Extra Additives (Stacks)</label>
                        <div style="background:var(--bg); border:1px solid var(--border); border-radius:8px; padding:15px;">
                            <div class="calc-group" style="margin-bottom:8px;">
                                <label class="calc-label" style="text-transform:none;opacity:0.8;">Shield of Trust (Footsteps)</label>
                                <div class="input-group-x">
                                    <select id="ms-shield" class="input-dark ms-trigger"><option value="0">None</option></select>
                                    <button class="btn-x" onclick="resetMsInput('ms-shield')">×</button>
                                </div>
                            </div>
                            <div class="calc-group" style="margin-bottom:8px;">
                                <label class="calc-label" style="text-transform:none;opacity:0.8;">Shoe Set Effect</label>
                                <div class="input-group-x">
                                    <select id="ms-shoe-set" class="input-dark ms-trigger">
                                        <option value="0">None</option>
                                        <option value="10">Eweca (10%)</option>
                                        <option value="12">Ladeca (12%)</option>
                                    </select>
                                    <button class="btn-x" onclick="resetMsInput('ms-shoe-set')">×</button>
                                </div>
                            </div>
                            <div class="calc-group" style="margin-bottom:8px;">
                                <label class="calc-label" style="text-transform:none;opacity:0.8;">Breath of Ladeca (15%)</label>
                                <label class="toggle-row">
                                    <span id="lbl-ms-ladeca-breath">Inactive</span>
                                    <input type="checkbox" id="ms-ladeca-breath" class="toggle-input ms-trigger">
                                    <div class="toggle-switch"></div>
                                </label>
                            </div>
                            <div class="calc-group">
                                <label class="calc-label" style="text-transform:none;opacity:0.8;">Ultimate Spirit (60%)</label>
                                <label class="toggle-row">
                                    <span id="lbl-ms-spirit">Inactive</span>
                                    <input type="checkbox" id="ms-spirit" class="toggle-input ms-trigger">
                                    <div class="toggle-switch"></div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- RIGHT PANEL -->
            <div class="panel right-panel" id="right-panel">
                <div class="drawer-header">
                    <span class="drawer-title">Multipliers</span>
                    <button class="drawer-close" onclick="closeSidebars()">×</button>
                </div>
                
                <!-- EXP Multipliers (Shown when leveling) -->
                <div id="panel-exp-mults">
                    <div class="config-section">
                        <label class="panel-label" style="color:var(--accent);">ACTIVE BUFFS</label>
                        <div id="multiplier-list"></div>
                    </div>

                    <div class="config-section" style="border-bottom:none;">
                        <label class="panel-label">Add Custom Buff</label>
                        <div style="display:flex; gap:8px; margin-bottom:8px;">
                            <input type="text" id="new-mult-name" class="input-dark" placeholder="Name (e.g. GM Event)" style="flex:1;">
                            <input type="number" id="new-mult-val" class="input-dark" style="width:70px;" placeholder="%" step="0.1">
                        </div>
                        <div style="display:flex; gap:8px; margin-bottom:12px;">
                            <select id="new-mult-type" class="input-dark">
                                <option value="mult">Multiplier (x)</option>
                                <option value="bonus">Bonus (%)</option>
                            </select>
                            <button onclick="addMultiplier()" class="hub-btn" style="background:var(--card-bg); border-color:var(--text-dim); justify-content:center; flex:1;">+ Add</button>
                        </div>
                    </div>

                    <!-- SECTION: KILLS (CHAR EXP) -->
                    <div class="config-section" id="section-kills" style="border-top:1px solid var(--border);">
                        <label class="panel-label">Estimated Kills</label>
                        <div style="background:var(--card-bg); border-radius:8px; padding:10px; font-size:12px;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                                <span style="color:var(--text-dim);">Baltane (Zombies)</span>
                                <span id="run-zombie" style="color:#fff;">0</span>
                            </div>
                            <div style="display:flex; justify-content:space-between;">
                                <span style="color:var(--text-dim);">Tech Duinn Mobs</span>
                                <span id="run-tech" style="color:#fff;">0</span>
                            </div>
                             <div style="margin-top:4px; font-size:9px; color:var(--text-dim); text-align:right;">(Turtle/Crab/Millipede)</div>
                        </div>
                    </div>

                     <!-- SECTION: ARTIFACTS (EXPL EXP) -->
                     <div class="config-section" id="section-artifacts" style="display:none; border-top:1px solid var(--border);">
                        <label class="panel-label">Estimated Sources</label>
                        <div id="artifact-list" style="background:var(--card-bg); border-radius:8px; padding:10px;">
                            <!-- JS populated -->
                        </div>
                        <div style="margin-top:4px; font-size:9px; color:var(--text-dim); text-align:right;" id="art-note">*Uses specific formulas for Gems vs Items</div>
                    </div>
                </div>
                
                <!-- MS CONFIG PANEL (Shown when Move Speed) -->
                <div id="panel-ms-config" style="display:none;">
                    <div class="config-section">
                        <label class="panel-label">Base Settings</label>
                        <div style="background:var(--card-bg); border:1px solid var(--border); border-radius:8px; padding:15px; margin-bottom:20px;">
                            <div class="calc-group" style="margin-bottom:10px;">
                                <label class="calc-label" style="text-transform:none;opacity:0.8;">Race</label>
                                <select id="ms-race" class="input-dark ms-trigger">
                                    <option value="116">Human (116%)</option>
                                    <option value="133">Elf (133%)</option>
                                    <option value="116">Giant (116%)</option>
                                </select>
                            </div>
                            <div class="calc-group">
                                <label class="calc-label" style="text-transform:none;opacity:0.8;">Commerce Mode</label>
                                <label class="toggle-row">
                                    <span id="lbl-ms-commerce-mode">Inactive</span>
                                    <input type="checkbox" id="ms-commerce-mode" class="toggle-input ms-trigger">
                                    <div class="toggle-switch"></div>
                                </label>
                            </div>
                        </div>

                        <label class="panel-label">Multipliers</label>
                        <div style="background:var(--card-bg); border:1px solid var(--border); border-radius:8px; padding:15px;">
                            <div class="calc-group" style="margin-bottom:10px;">
                                <label class="calc-label" style="text-transform:none;opacity:0.8;">Blannid's Blessing</label>
                                <div class="input-group-x">
                                    <select id="ms-blannid" class="input-dark ms-trigger">
                                        <option value="0">None</option>
                                        <option value="0.02">Lvl 1 (2%)</option>
                                        <option value="0.04">Lvl 2 (4%)</option>
                                        <option value="0.06">Lvl 3 (6%)</option>
                                        <option value="0.08">Lvl 4 (8%)</option>
                                    </select>
                                    <button class="btn-x" onclick="resetMsInput('ms-blannid')">×</button>
                                </div>
                            </div>
                            <div class="calc-group" style="margin-bottom:10px;">
                                <label class="calc-label" style="text-transform:none;opacity:0.8;">Speed Totem</label>
                                <div class="input-group-x">
                                    <select id="ms-speed-totem" class="input-dark ms-trigger">
                                        <option value="0">None</option>
                                        <option value="0.01">1%</option>
                                        <option value="0.02">2%</option>
                                        <option value="0.03">3%</option>
                                    </select>
                                    <button class="btn-x" onclick="resetMsInput('ms-speed-totem')">×</button>
                                </div>
                            </div>
                            <div class="calc-group" style="margin-bottom:10px;">
                                <label class="calc-label" style="text-transform:none;opacity:0.8;">Ladeca Boost (Buff)</label>
                                <div class="input-group-x">
                                    <select id="ms-ladeca-buff" class="input-dark ms-trigger">
                                        <option value="0">None</option>
                                        <option value="0.01">1%</option>
                                        <option value="0.02">2%</option>
                                        <option value="0.03">3%</option>
                                    </select>
                                    <button class="btn-x" onclick="resetMsInput('ms-ladeca-buff')">×</button>
                                </div>
                            </div>
                            <div class="calc-group">
                                <label class="calc-label" style="text-transform:none;opacity:0.8;">Floral Fairy (10%)</label>
                                <label class="toggle-row">
                                    <span id="lbl-ms-floral-fairy">Inactive</span>
                                    <input type="checkbox" id="ms-floral-fairy" class="toggle-input ms-trigger">
                                    <div class="toggle-switch"></div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    const firebaseConfig = { apiKey: "AIzaSyC7A3Rzi-VddhqZiFGjHjjqBwCdX1ks6yM", authDomain: "mabinogi-tracker.firebaseapp.com", databaseURL: "https://mabinogi-tracker-default-rtdb.firebaseio.com", projectId: "mabinogi-tracker", storageBucket: "mabinogi-tracker.firebasestorage.app", appId: "1:267690802644:web:fccdd005d5c8990504ea41", measurementId: "G-VBDBKQ3M1B" };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

    let currentUser = null;
    let currentMode = 'char-exp'; 

    // --- SEPARATE DATA TABLES ---
    let CHAR_EXP_TABLE = [];
    let EXPL_EXP_TABLE = [];
    
    // Updated: Real Mabinogi Character EXP Totals (Levels 1 to 200)
    const REAL_CHAR_EXP_TOTALS = [
        0, 400, 1100, 2100, 3400, 5000, 6800, 8800, 11000, 13400,
        16000, 18800, 21800, 25100, 28700, 32600, 36900, 41600, 46700, 52300,
        58500, 65300, 72900, 81300, 90600, 100900, 112200, 124700, 138500, 153800,
        170600, 189100, 209400, 231600, 255900, 282500, 311500, 343100, 377500, 414800,
        455200, 498900, 546100, 597000, 651800, 710800, 774100, 842000, 914700, 992400,
        1075400, 1163900, 1258200, 1358600, 1465300, 1578600, 1698800, 1826100, 1960900, 2103400,
        2254000, 2413000, 2580600, 2757300, 2943300, 3139000, 3344700, 3560700, 3787400, 4025200,
        4274400, 4535400, 4808600, 5094300, 5393000, 5705000, 6030700, 6370600, 6725000, 7094400,
        7479200, 7879800, 8296700, 8730300, 9181000, 9649400, 10135800, 10640700, 11164700, 11708100,
        12271500, 12855400, 13460200, 14086500, 14734700, 15405400, 16099100, 16816300, 17557600, 18323500,
        18572500, 18836500, 19116500, 19413500, 19728500, 20062500, 20416500, 20791500, 21188500, 21608500,
        22052500, 22521500, 23016500, 23538500, 24088500, 24667500, 25276500, 25916500, 26588500, 27293500,
        28032500, 28806500, 29616500, 30463500, 31348500, 32272500, 33236500, 34241500, 35288500, 36378500,
        37512500, 38691500, 39916500, 41188500, 42508500, 43877500, 45296500, 46766500, 48288500, 49863500,
        51492500, 53176500, 54916500, 56713500, 58568500, 60482500, 62456500, 64491500, 66588500, 68748500,
        70972500, 73261500, 75616500, 78038500, 80528500, 83087500, 85716500, 88416500, 91188500, 94033500,
        96952500, 99946500, 103016500, 106163500, 109388500, 112692500, 116076500, 119541500, 123088500, 126718500,
        130432500, 134231500, 138116500, 142088500, 146148500, 150297500, 154536500, 158866500, 163288500, 167803500,
        172412500, 177116500, 181916500, 186813500, 191808500, 196902500, 202096500, 207391500, 212788500, 218288500,
        223893500, 229608500, 235438500, 241388500, 247463500, 253668500, 260013500, 266508500, 273163500, 279988500
    ];

    // Updated: Real Mabinogi Exploration EXP Totals (Levels 1 to 50)
    const REAL_EXPL_EXP_TOTALS = [
        0, 676, 1984, 3886, 6350, 9350, 12866, 16884, 21396, 26400,
        31900, 37906, 44434, 51506, 59150, 67400, 76296, 85884, 96216, 107350,
        119350, 132286, 146234, 161276, 177500, 195000, 213876, 234234, 256186, 279850,
        305350, 332816, 362384, 394196, 428400, 465150, 504606, 546934, 592306, 640900,
        692900, 748496, 807884, 871266, 938850, 1010850, 1087486, 1168984, 1255576, 1347500
    ];

    // Exploration Items
    const EXPL_ITEMS = [
        { name: "Serving Crock", exp: 20000, type: 'standard' },
        { name: "Small Hippo", exp: 24000, type: 'standard' },
        { name: "Tabula Ocular", exp: 28000, type: 'standard' },
        { name: "Elephant Statue", exp: 2920, type: 'standard' },
        { name: "Fynni Gem (A)", exp: 3600, type: 'fynni' },
        { name: "Fynni Gem (B)", exp: 2700, type: 'fynni' },
        { name: "Fynni Gem (C)", exp: 1800, type: 'fynni' },
        { name: "Fynni Gem (D)", exp: 900, type: 'fynni' },
        { name: "Fynni Gem (E)", exp: 180, type: 'fynni' }
    ];

    // Exploration Mastery Bonuses (Add to 1)
    const EXPL_MASTERY_BONUS = {
        'N': 0, 'F': 0, 'E': 0.10, 'D': 0.15, 'C': 0.20, 'B': 0.25, 'A': 0.30, 
        '9': 0.35, '8': 0.40, '7': 0.45, '6': 0.50, '5': 0.55, '4': 0.60, '3': 0.65, 
        '2': 0.70, '1': 0.80
    };

    // Init Tables
    for(let i=1; i<=200; i++) {
        let total = 0;
        if(i <= REAL_CHAR_EXP_TOTALS.length) total = REAL_CHAR_EXP_TOTALS[i-1];
        else total = REAL_CHAR_EXP_TOTALS[REAL_CHAR_EXP_TOTALS.length-1] + (i - 200) * 10000000;

        let req = 0;
        if(i < REAL_CHAR_EXP_TOTALS.length) req = REAL_CHAR_EXP_TOTALS[i] - REAL_CHAR_EXP_TOTALS[i-1];

        CHAR_EXP_TABLE.push({ level: i, req: req, total: total });
    }

    // UPDATED: Use REAL_EXPL_EXP_TOTALS instead of placeholder formula
    for(let i=1; i<=50; i++) {
        let total = 0;
        if(i <= REAL_EXPL_EXP_TOTALS.length) total = REAL_EXPL_EXP_TOTALS[i-1];
        else total = REAL_EXPL_EXP_TOTALS[REAL_EXPL_EXP_TOTALS.length-1] + (i - 50) * 200000; // Fallback

        let req = 0;
        if(i < REAL_EXPL_EXP_TOTALS.length) req = REAL_EXPL_EXP_TOTALS[i] - REAL_EXPL_EXP_TOTALS[i-1];

        EXPL_EXP_TABLE.push({ level: i, req: req, total: total });
    }

    // --- SEPARATE STATE OBJECTS ---
    let charState = {
        totalExp: 0,
        tgt: 200,
        multipliers: []
    };
    
    let explState = {
        totalExp: 0,
        tgt: 50,
        multipliers: [],
        mastery: 'N',
        bell: 0,
        customBase: 0
    };

    // Move Speed State
    let msState = {
        race: 116,
        commerce: false,
        shield: 0, shoeSet: 0, spirit: false, ladecaBreath: false, // Extras
        totem: 0, reforge: 0, demigod: false, title: 0, march: 0, // G1
        petBuff: false, potion: 0, cloak: false, shylock: false, alpaca: false, commReforge: 0, // G2
        blannid: 0, speedTotem: 0, ladecaBuff: 0, floral: false // Multipliers
    };

    // --- DEFAULT BUFFS ---
    const CHAR_DEFAULTS = [
        { id: 'def_pot', name: '2x EXP Potion', val: 2.0, active: false, fixed: true, group: 'potion' },
        { id: 'def_pot4', name: '4x EXP Potion', val: 4.0, active: false, fixed: true, group: 'potion' },
        { id: 'def_pot5', name: '5x EXP Potion', val: 5.0, active: false, fixed: true, group: 'potion' },
        { id: 'def_vip', name: 'VIP Service (+20%)', val: 1.2, active: false, fixed: true },
        { id: 'def_prism', name: 'Yellow Prism (2x)', val: 2.0, active: false, fixed: true },
        { id: 'def_talent', name: 'Cleric/Talent (2x)', val: 2.0, active: false, fixed: true },
        { id: 'def_branch', name: 'Branches of Mabi (+20%)', val: 1.2, active: false, fixed: true },
        { id: 'def_vision', name: 'Enlightened Vision (+45%)', val: 1.45, active: false, fixed: true },
        { id: 'def_hebona', name: 'Fest. Hebona Robe (+10%)', val: 1.1, active: false, fixed: true },
        { id: 'grace', name: "Goddess' Grace", val: 1.01, active: false, fixed: true, mode: 'passive', modes: { 'passive': {name:'Passive (+1%)', val: 1.01}, 'active': {name:'Active (+10%)', val: 1.1} } },
        { id: 'champ', name: "Commerce Champion", val: 1.1, active: false, fixed: true, special: 'baltane_only', specialVal: 2.5 },
        { id: 'balt_1_5', name: 'Baltane Crystal (1.5x)', val: 1.5, active: false, fixed: true, group: 'baltane', special: 'baltane_only' },
        { id: 'balt_2', name: 'Baltane Crystal (2x)', val: 2.0, active: false, fixed: true, group: 'baltane', special: 'baltane_only' },
        { id: 'balt_3', name: 'Baltane Crystal (3x)', val: 3.0, active: false, fixed: true, group: 'baltane', special: 'baltane_only' }
    ];

    const EXPL_DEFAULTS = [
        { id: 'adv_robe', name: 'Adventurer Robe (+15%)', val: 1.15, active: false, fixed: true },
        { id: 'grandmaster', name: 'Grandmaster Adventurer (+50%)', val: 1.50, active: false, fixed: true }
    ];

    // Init state with deep copy
    charState.multipliers = JSON.parse(JSON.stringify(CHAR_DEFAULTS));
    explState.multipliers = JSON.parse(JSON.stringify(EXPL_DEFAULTS));

    // --- AUTH ---
    auth.onAuthStateChanged(user => {
        
        if (user) {
            currentUser = user;
            db.ref(`users/${user.uid}/calc_state_v2`).once('value', s => loadState(s.val()));
        } else {
            currentUser = { uid: 'local_guest', isGuest: true };
            
            loadState(JSON.parse(localStorage.getItem('mabi_calc_state_v2') || '{}'));
        }
    });

    // --- SWITCH TOOLS ---
    function setTool(mode) {
        if(mode === 'ego-feed' || mode === 'erg-break') { alert('Work in Progress!'); return; }
        
        if(currentMode === 'char-exp') saveInputsToState(charState);
        else if(currentMode === 'explore-exp') saveInputsToState(explState);
        // msState saves automatically on input, but force a save here to be safe
        if(currentMode === 'move-speed') saveFullState();
        
        currentMode = mode;
        
        document.getElementById('btn-char-exp').classList.toggle('active', mode === 'char-exp');
        document.getElementById('btn-explore-exp').classList.toggle('active', mode === 'explore-exp');
        document.getElementById('btn-move-speed').classList.toggle('active', mode === 'move-speed');
        
        // Panels
        document.getElementById('tool-char-exp').style.display = (mode === 'char-exp' || mode === 'explore-exp') ? 'block' : 'none';
        document.getElementById('tool-move-speed').style.display = (mode === 'move-speed') ? 'block' : 'none';
        
        // Right Panel Sections
        const isMs = (mode === 'move-speed');
        const msConfig = document.getElementById('panel-ms-config');
        const expMults = document.getElementById('panel-exp-mults');
        
        if (msConfig) msConfig.style.display = isMs ? 'block' : 'none';
        if (expMults) expMults.style.display = !isMs ? 'block' : 'none';

        if (isMs) {
            document.getElementById('calc-title').innerText = "Move Speed";
            loadMsInputs();
            calcMoveSpeed();
        } else {
            document.getElementById('calc-title').innerText = mode === 'char-exp' ? "Character Level" : "Exploration Level";
            
            // Visibility Toggles
            document.getElementById('section-kills').style.display = (mode === 'char-exp') ? 'block' : 'none';
            document.getElementById('section-artifacts').style.display = (mode === 'explore-exp') ? 'block' : 'none';
            document.getElementById('expl-settings').style.display = (mode === 'explore-exp') ? 'grid' : 'none';

            const newState = mode === 'char-exp' ? charState : explState;
            loadInputsFromState(newState);
            renderMultipliers();
            calculateExp();
        }
        
        if(window.innerWidth <= 1000) closeSidebars();
        saveFullState();
    }

    function saveInputsToState(stateObj) {
        stateObj.totalExp = document.getElementById('cur-total-exp').value;
        stateObj.tgt = document.getElementById('tgt-lvl').value;
        if (currentMode === 'explore-exp') {
            stateObj.mastery = document.getElementById('expl-mastery').value;
            stateObj.bell = document.getElementById('fynn-bell').value;
            stateObj.customBase = document.getElementById('custom-base-exp').value;
        }
    }
    
    function loadInputsFromState(stateObj) {
        document.getElementById('cur-total-exp').value = stateObj.totalExp || "";
        document.getElementById('tgt-lvl').value = stateObj.tgt || (currentMode==='char-exp'?200:50);
        if (currentMode === 'explore-exp') {
            document.getElementById('expl-mastery').value = stateObj.mastery || 'N';
            document.getElementById('fynn-bell').value = stateObj.bell || 0;
            document.getElementById('custom-base-exp').value = stateObj.customBase || "";
        }
    }

    // --- PERSISTENCE ---
    function saveFullState() {
        if(currentMode === 'char-exp') saveInputsToState(charState);
        else if(currentMode === 'explore-exp') saveInputsToState(explState);
        
        const fullData = { char: charState, expl: explState, ms: msState, lastMode: currentMode };
        
        if(currentUser && !currentUser.isGuest) db.ref(`users/${currentUser.uid}/calc_state_v2`).set(fullData);
        else localStorage.setItem('mabi_calc_state_v2', JSON.stringify(fullData));
    }

    // Debounce wrapper to prevent spamming DB on input
    let saveDebounceTimer;
    function saveFullStateDebounced() {
        clearTimeout(saveDebounceTimer);
        saveDebounceTimer = setTimeout(saveFullState, 1000);
    }

    function loadState(data) {
        if(!data) return;
        
        if(data.char) {
            charState.totalExp = data.char.totalExp;
            charState.tgt = data.char.tgt;
            if(data.char.multipliers) charState.multipliers = mergeSavedMults(CHAR_DEFAULTS, data.char.multipliers);
        }
        if(data.expl) {
            explState.totalExp = data.expl.totalExp;
            explState.tgt = data.expl.tgt;
            if(data.expl.multipliers) explState.multipliers = mergeSavedMults(EXPL_DEFAULTS, data.expl.multipliers);
            explState.mastery = data.expl.mastery || 'N';
            explState.bell = data.expl.bell || 0;
            explState.customBase = data.expl.customBase || "";
        }
        if(data.ms) {
            msState = { ...msState, ...data.ms }; // Merge saved with defaults
        }
        
        // Populate MS Dropdowns once
        populateMsDropdowns();

        if(data.lastMode) setTool(data.lastMode);
        else {
             renderMultipliers();
             calculateExp();
        }
    }
    
    function mergeSavedMults(defaults, saved) {
        let merged = JSON.parse(JSON.stringify(defaults));
        if(!saved) return merged;
        const savedMap = {};
        saved.forEach(m => savedMap[m.id] = m);
        
        merged.forEach(def => {
            const s = savedMap[def.id];
            if(s) {
                def.active = s.active;
                if(s.mode && def.modes) {
                     def.mode = s.mode;
                     if(def.modes[s.mode]) def.val = def.modes[s.mode].val;
                }
            }
        });
        saved.forEach(m => {
            if(!defaults.find(d => d.id === m.id)) merged.push(m);
        });
        return merged;
    }

    // --- EXP CALCULATION CORE ---
    function formatInput(input) {
        let val = input.value.replace(/,/g, '');
        let number = parseFloat(val);
        if(!isNaN(number)) {
                // 'maximumFractionDigits: 20' ensures we don't cut off your decimal places
                input.value = number.toLocaleString('en-US', { maximumFractionDigits: 20 });
        }
            else {
                input.value = "";
            }
        }
        
    function updateTotalFromLevel(newLevel) {
        const lvl = parseInt(newLevel) || 1;
        const TABLE = currentMode === 'char-exp' ? CHAR_EXP_TABLE : EXPL_EXP_TABLE;
        const max = currentMode === 'char-exp' ? 200 : 50;
        if (lvl < 1 || lvl > max) return;
        const levelData = TABLE.find(d => d.level === lvl);
        if (levelData) {
            document.getElementById('cur-total-exp').value = levelData.total.toLocaleString();
            calculateExp();
        }
    }

    function calculateExp() {
        const rawVal = document.getElementById('cur-total-exp').value.replace(/,/g, '');
        const totalExp = parseFloat(rawVal) || 0; 
        const tgtLvl = parseInt(document.getElementById('tgt-lvl').value) || (currentMode==='char-exp'?200:50);
        const TABLE = currentMode === 'char-exp' ? CHAR_EXP_TABLE : EXPL_EXP_TABLE;
        const activeMults = currentMode === 'char-exp' ? charState.multipliers : explState.multipliers;
        
        // 1. Level & %
        let curLvl = 1, curPct = 0;
        for (let i = 0; i < TABLE.length; i++) {
            const lvlData = TABLE[i];
            const nextLvlData = TABLE[i+1];
            if (!nextLvlData) { curLvl = lvlData.level; curPct = 100; break; }
            if (totalExp >= lvlData.total && totalExp < nextLvlData.total) {
                curLvl = lvlData.level;
                const expInLevel = totalExp - lvlData.total;
                curPct = lvlData.req > 0 ? (expInLevel / lvlData.req) * 100 : 0;
                break;
            }
        }
        
        if(document.activeElement.id !== 'disp-lvl') document.getElementById('disp-lvl').value = curLvl;
        document.getElementById('disp-pct').innerText = curPct.toFixed(2) + "%";

        // 2. Needed
        let targetTotalExp = 0;
        const targetData = TABLE.find(d => d.level === tgtLvl);
        if (targetData) targetTotalExp = targetData.total;
        let diff = targetTotalExp - totalExp;
        if (diff < 0) diff = 0;
        
        document.getElementById('res-exp').innerText = diff.toLocaleString();
        document.getElementById('res-sub').innerText = diff > 0 ? `To reach Level ${tgtLvl}` : "Target Reached";

        // 3. Runs / Artifacts
        if (currentMode === 'char-exp') {
            let generalMult = 1.0;
            let baltaneMult = 1.0;

            activeMults.forEach(m => {
                if (m.active) {
                    if (m.id === 'champ') { generalMult *= m.val; baltaneMult *= m.specialVal; }
                    else if (m.special === 'baltane_only') { baltaneMult *= m.val; }
                    else { generalMult *= m.val; baltaneMult *= m.val; }
                }
            });

            const techMobExp = 18457 * generalMult;
            const zombieExp = 9000 * baltaneMult;

            document.getElementById('run-zombie').innerText = Math.ceil(diff / zombieExp).toLocaleString();
            document.getElementById('run-tech').innerText = Math.ceil(diff / techMobExp).toLocaleString();
        } else {
             // EXPLORATION CALC
             const masteryKey = document.getElementById('expl-mastery').value;
             const masteryBonus = EXPL_MASTERY_BONUS[masteryKey] || 0.0;
             const bellPct = parseFloat(document.getElementById('fynn-bell').value) || 0;
             const bellEfficiency = bellPct / 100;
             
             const customBaseRaw = document.getElementById('custom-base-exp').value.replace(/[,.]/g, '');
             const customBase = parseFloat(customBaseRaw) || 0;

             let robeBonus = 0;
             let gmBonus = 0;
             let eventMult = 1.0;

             activeMults.forEach(m => {
                 if (m.active) {
                    if (m.id === 'adv_robe') robeBonus = 0.15;
                    else if (m.id === 'grandmaster') gmBonus = 0.50;
                    else eventMult *= m.val; 
                 }
             });

             const artList = document.getElementById('artifact-list');
             artList.innerHTML = '';
             
             // 1. Standard Items
             EXPL_ITEMS.forEach(item => {
                 let finalExp = 0;
                 if (item.type === 'fynni') {
                     // Fynni Formula: Base * (1 + (Robe * 5/9) + (GM * 5/9)) * Event
                     const efficiency = 5/9;
                     const effBonus = (robeBonus * efficiency) + (gmBonus * efficiency);
                     finalExp = item.exp * (1 + effBonus) * eventMult;
                 } else {
                     // Standard Formula: Base * (1 + Robe + GM) * Event
                     finalExp = item.exp * (1 + robeBonus + gmBonus) * eventMult;
                 }
                 
                 const req = Math.ceil(diff / finalExp);
                 const div = document.createElement('div');
                 div.className = 'artifact-row';
                 div.innerHTML = `<span class="artifact-name">${item.name}</span><span class="artifact-val">${req.toLocaleString()}</span>`;
                 artList.appendChild(div);
             });

             // 2. Fynn Crafting
             if (customBase > 0) {
                 let customFinal = 0;
                 let impossible = false;
                 
                 if (bellPct <= 0) impossible = true;
                 else {
                     customFinal = (customBase * bellEfficiency) * (1 + masteryBonus + robeBonus + gmBonus) * eventMult;
                 }

                 const div = document.createElement('div');
                 div.className = 'artifact-row';
                 div.style.marginTop = '10px';
                 div.style.paddingTop = '10px';
                 div.style.borderTop = '1px dashed var(--border)';
                 
                 if (impossible) {
                     div.innerHTML = `<span class="artifact-name" style="color:var(--accent);">Fynn Crafting Item</span><span class="artifact-val" style="color:var(--danger)">Bell Required</span>`;
                 } else {
                     const req = Math.ceil(diff / customFinal);
                     div.innerHTML = `<span class="artifact-name" style="color:var(--accent);">Fynn Crafting Item</span><span class="artifact-val">${req.toLocaleString()}</span>`;
                 }
                 artList.appendChild(div);
             }
        }
        
        saveFullState();
    }

    // --- MULTIPLIERS UI ---
    function formatMultiplierDisplay(val) {
        if (val >= 2.0 && val % 1 === 0) return Math.round(val) + "x"; 
        if (val >= 2.0) return val + "x"; 
        const pct = Math.round((val - 1) * 100);
        return "+" + pct + "%";
    }

    function renderMultipliers() {
        const list = document.getElementById('multiplier-list');
        list.innerHTML = '';
        
        const arr = currentMode === 'char-exp' ? charState.multipliers : explState.multipliers;
        
        const groups = { potion: { name: 'EXP Potion', items: [] }, baltane: { name: 'Baltane Crystal', items: [] } };
        const others = [];
        
        arr.forEach((m, idx) => {
            if (m.group && groups[m.group]) groups[m.group].items.push({...m, idx});
            else others.push({...m, idx});
        });

        Object.keys(groups).forEach(gKey => {
            const grp = groups[gKey];
            if(grp.items.length === 0) return;
            const div = document.createElement('div');
            div.className = 'mult-group-container';
            let optionsHtml = `<option value="none">None</option>`;
            grp.items.forEach(i => {
                optionsHtml += `<option value="${i.idx}" ${i.active?'selected':''}>${i.name} (${formatMultiplierDisplay(i.val)})</option>`;
            });
            div.innerHTML = `<div class="mult-group-label">${grp.name}</div><select class="input-dark" onchange="toggleGroupMult(this.value, '${gKey}')">${optionsHtml}</select>`;
            list.appendChild(div);
        });

        others.forEach(item => {
            const div = document.createElement('div');
            div.className = 'mult-item';
            let extra = '';
            if(item.modes) {
                const currentModeKey = item.mode || 'passive';
                const label = item.modes[currentModeKey].name;
                extra = `<div style="cursor:pointer; color:var(--accent); font-size:10px; margin-right:8px; border:1px solid var(--border); padding:2px 4px; border-radius:4px;" onclick="setMultMode(${item.idx}, '${currentModeKey==='passive'?'active':'passive'}')">${label} ⇄</div>`;
            } else if (item.id === 'champ') {
                 extra = `<div style="font-size:9px; color:var(--success); margin-right:5px;">(Baltane Boost)</div>`;
            }

            let valDisplay = item.val >= 2.0 || item.val % 1 !== 0 ? item.val + "x" : "+" + Math.round((item.val-1)*100) + "%";
            if (item.val >= 2.0 && item.val % 1 === 0) valDisplay = Math.round(item.val) + "x";

            div.innerHTML = `
                <div class="mult-info">
                    <label style="display:flex; align-items:center; cursor:pointer;">
                        <input type="checkbox" class="toggle-input" ${item.active ? 'checked' : ''} onchange="toggleMult(${item.idx})">
                        <div class="toggle-switch" style="transform:scale(0.8); margin:0;"></div>
                    </label>
                    <span style="font-size:12px; color:${item.active ? '#fff' : 'var(--text-dim)'}; margin-left: 10px;">${item.name}</span>
                </div>
                <div style="display:flex; align-items:center; gap:5px;">
                    ${extra}
                    <span class="mult-val">${valDisplay}</span>
                    ${!item.fixed ? `<button onclick="deleteMult(${item.idx})" class="btn-mini del">×</button>` : ''}
                </div>
            `;
            list.appendChild(div);
        });
    }

    function toggleGroupMult(val, groupKey) {
        const arr = currentMode === 'char-exp' ? charState.multipliers : explState.multipliers;
        arr.forEach(m => { if(m.group === groupKey) m.active = false; });
        if (val !== 'none') {
            const idx = parseInt(val);
            if(arr[idx]) arr[idx].active = true;
        }
        renderMultipliers();
        calculateExp();
    }

    function toggleMult(idx) {
        const arr = currentMode === 'char-exp' ? charState.multipliers : explState.multipliers;
        arr[idx].active = !arr[idx].active;
        renderMultipliers();
        calculateExp();
    }
    
    function setMultMode(idx, key) {
        const arr = currentMode === 'char-exp' ? charState.multipliers : explState.multipliers;
        const m = arr[idx];
        m.mode = key;
        m.val = m.modes[key].val;
        renderMultipliers();
        calculateExp();
    }

    function addMultiplier() {
        const name = document.getElementById('new-mult-name').value.trim();
        let valInput = parseFloat(document.getElementById('new-mult-val').value);
        const type = document.getElementById('new-mult-type').value;
        if(!name || !valInput) return;

        let finalVal = 1.0;
        if (type === 'bonus') finalVal = 1 + (valInput / 100);
        else finalVal = valInput;
        
        const arr = currentMode === 'char-exp' ? charState.multipliers : explState.multipliers;
        arr.push({ id: Date.now(), name, val: finalVal, active: true, fixed: false });
        
        document.getElementById('new-mult-name').value = '';
        document.getElementById('new-mult-val').value = '';
        renderMultipliers();
        calculateExp();
    }

    function deleteMult(idx) {
        const arr = currentMode === 'char-exp' ? charState.multipliers : explState.multipliers;
        arr.splice(idx, 1);
        renderMultipliers();
        calculateExp();
    }

    // --- MOVE SPEED CALCULATOR LOGIC ---
    function populateMsDropdowns() {
        // Wave Sweeper (Specific Ranks)
        const totemSel = document.getElementById('ms-totem');
        if(totemSel && totemSel.children.length === 1) {
            const ranks = [
                { val: 2, label: "Rank C (2%)" },
                { val: 6, label: "Rank B (6%)" },
                { val: 10, label: "Rank A (10%)" },
                { val: 16, label: "Rank S (16%)" },
                { val: 18, label: "Exquisite (18%)" }
            ];
            ranks.forEach(r => {
                const opt = document.createElement('option');
                opt.value = r.val;
                opt.innerText = r.label;
                totemSel.appendChild(opt);
            });
        }
        // Shoe Reforge (1-5)
        const reforgeSel = document.getElementById('ms-reforge');
        if(reforgeSel && reforgeSel.children.length === 1) {
            for(let i=1; i<=5; i++) {
                const opt = document.createElement('option'); opt.value = i*3; opt.innerText = `Level ${i} (${i*3}%)`; reforgeSel.appendChild(opt);
            }
        }
        // Commerce Reforge (1-20)
        const commSel = document.getElementById('ms-commerce-reforge');
        if(commSel && commSel.children.length === 1) {
            for(let i=1; i<=20; i++) {
                const opt = document.createElement('option'); opt.value = i*3; opt.innerText = `Level ${i} (${i*3}%)`; commSel.appendChild(opt);
            }
        }
        // Shield (1-15)
        const shieldSel = document.getElementById('ms-shield');
        if(shieldSel && shieldSel.children.length === 1) {
            for(let i=1; i<=15; i++) {
                const val = 10 + ((i-1)*2);
                const opt = document.createElement('option'); opt.value = val; opt.innerText = `Level ${i} (${val}%)`; shieldSel.appendChild(opt);
            }
        }
    }

    function loadMsInputs() {
        if(!msState) return;
        document.getElementById('ms-race').value = msState.race || 116;
        document.getElementById('ms-commerce-mode').checked = msState.commerce || false;
        
        // G1
        document.getElementById('ms-totem').value = msState.totem || 0;
        document.getElementById('ms-reforge').value = msState.reforge || 0;
        document.getElementById('ms-demigod').checked = msState.demigod || false;
        document.getElementById('ms-title').value = msState.title || 0;
        document.getElementById('ms-march').value = msState.march || 0;
        
        // G2
        document.getElementById('ms-pet-buff').checked = msState.petBuff || false;
        document.getElementById('ms-potion').value = msState.potion || 0;
        document.getElementById('ms-cloak').checked = msState.cloak || false;
        document.getElementById('ms-shylock').checked = msState.shylock || false;
        document.getElementById('ms-alpaca').checked = msState.alpaca || false;
        document.getElementById('ms-commerce-reforge').value = msState.commReforge || 0;
        
        // Extras
        document.getElementById('ms-shield').value = msState.shield || 0;
        document.getElementById('ms-shoe-set').value = msState.shoeSet || 0;
        document.getElementById('ms-spirit').checked = msState.spirit || false;
        document.getElementById('ms-ladeca-breath').checked = msState.ladecaBreath || false;
        
        // Multipliers
        document.getElementById('ms-blannid').value = msState.blannid || 0;
        document.getElementById('ms-speed-totem').value = msState.speedTotem || 0;
        document.getElementById('ms-ladeca-buff').value = msState.ladecaBuff || 0;
        document.getElementById('ms-floral-fairy').checked = msState.floral || false;
    }

    function updateToggleLabel(id, textActive, textInactive) {
        const el = document.getElementById(id);
        const lbl = document.getElementById('lbl-' + id);
        if (el && lbl) {
            lbl.innerText = el.checked ? textActive : textInactive;
            lbl.style.color = el.checked ? '#fff' : 'var(--text-dim)';
        }
    }

    function calcMoveSpeed() {
        // Update State from DOM
        msState.race = document.getElementById('ms-race').value;
        msState.commerce = document.getElementById('ms-commerce-mode').checked;
        msState.totem = document.getElementById('ms-totem').value;
        msState.reforge = document.getElementById('ms-reforge').value;
        msState.demigod = document.getElementById('ms-demigod').checked;
        msState.title = document.getElementById('ms-title').value;
        msState.march = document.getElementById('ms-march').value;
        
        msState.petBuff = document.getElementById('ms-pet-buff').checked;
        msState.potion = document.getElementById('ms-potion').value;
        msState.cloak = document.getElementById('ms-cloak').checked;
        msState.shylock = document.getElementById('ms-shylock').checked;
        msState.alpaca = document.getElementById('ms-alpaca').checked;
        msState.commReforge = document.getElementById('ms-commerce-reforge').value;
        
        msState.shield = document.getElementById('ms-shield').value;
        msState.shoeSet = document.getElementById('ms-shoe-set').value;
        msState.spirit = document.getElementById('ms-spirit').checked;
        msState.ladecaBreath = document.getElementById('ms-ladeca-breath').checked;
        
        msState.blannid = document.getElementById('ms-blannid').value;
        msState.speedTotem = document.getElementById('ms-speed-totem').value;
        msState.ladecaBuff = document.getElementById('ms-ladeca-buff').value;
        msState.floral = document.getElementById('ms-floral-fairy').checked;

        saveFullStateDebounced(); // Persist

        // Reactive Labels Update
        updateToggleLabel('ms-commerce-mode', 'Active', 'Inactive');
        updateToggleLabel('ms-demigod', 'Active (40%)', 'Inactive');
        updateToggleLabel('ms-pet-buff', 'Active (55%)', 'Inactive');
        updateToggleLabel('ms-cloak', 'Active (100%)', 'Inactive');
        updateToggleLabel('ms-shylock', 'Active (100%)', 'Inactive');
        updateToggleLabel('ms-alpaca', 'Equipped (20%)', 'Unequipped');
        updateToggleLabel('ms-ladeca-breath', 'Active (15%)', 'Inactive');
        updateToggleLabel('ms-spirit', 'Active (60%)', 'Inactive');
        updateToggleLabel('ms-floral-fairy', 'Active (10%)', 'Inactive');

        // UI Toggle Logic
        const isCommerce = msState.commerce;
        const alpacaWrap = document.getElementById('ms-alpaca-wrap');
        const commRefWrap = document.getElementById('ms-comm-reforge-wrap');
        
        if(isCommerce) {
            alpacaWrap.classList.remove('form-group-disabled');
            commRefWrap.classList.remove('form-group-disabled');
        } else {
            alpacaWrap.classList.add('form-group-disabled');
            commRefWrap.classList.add('form-group-disabled');
            // Removed reset logic so settings are preserved
        }

        // Calculation
        let base = parseFloat(msState.race);

        // Group 1 Sources
        const g1Sources = [
            parseInt(msState.totem),
            parseInt(msState.reforge),
            msState.demigod ? 40 : 0,
            parseFloat(msState.title) || 0,
            parseFloat(msState.march) || 0
        ];
        
        // Group 2 Sources
        const g2Sources = [
            msState.petBuff ? 55 : 0,
            parseInt(msState.potion),
            msState.cloak ? 100 : 0,
            msState.shylock ? 100 : 0,
            // Only apply Alpaca/Commerce Reforge if Commerce Mode is ON
            (isCommerce && document.getElementById('ms-alpaca').checked) ? 20 : 0, 
            isCommerce ? parseInt(document.getElementById('ms-commerce-reforge').value) : 0
        ];

        const g1Max = Math.max(...g1Sources);
        const g2Max = Math.max(...g2Sources);

        document.getElementById('ms-g1-max').innerText = `Max: ${g1Max}%`;
        document.getElementById('ms-g2-max').innerText = `Max: ${g2Max}%`;

        // Comparison
        const g1El = document.getElementById('ms-g1-max');
        const g2El = document.getElementById('ms-g2-max');
        g1El.classList.remove('winner');
        g2El.classList.remove('winner');

        let mainBonus = 0;
        if (g1Max >= g2Max) {
            mainBonus = g1Max;
            g1El.classList.add('winner');
        } else {
            mainBonus = g2Max;
            g2El.classList.add('winner');
        }

        // Stackable Extras
        let additive = 0;
        additive += parseInt(msState.shield);
        additive += parseInt(msState.shoeSet);
        if(msState.ladecaBreath) additive += 15;
        if(msState.spirit) additive += 60;

        // Multipliers
        let multipliers = [];
        
        const blannidVal = parseFloat(msState.blannid);
        if(blannidVal > 0) multipliers.push(1 + blannidVal);

        const totemVal = parseFloat(msState.speedTotem);
        if(totemVal > 0) multipliers.push(1 + totemVal);

        const ladecaVal = parseFloat(msState.ladecaBuff);
        if(ladecaVal > 0) multipliers.push(1 + ladecaVal);

        if(msState.floral) multipliers.push(1.10);

        // Calculation Step
        // Base + Additive %
        let currentSpeed = base + mainBonus + additive;

        // Apply Multipliers
        multipliers.forEach(m => {
            currentSpeed *= m;
        });

        document.getElementById('ms-final-speed').innerText = currentSpeed.toFixed(1) + '%';
    }

    // Helper for 'X' button
    window.resetMsInput = (id) => {
        const el = document.getElementById(id);
        if(!el) return;
        if(el.type === 'number' || el.tagName === 'SELECT') el.value = 0;
        else if (el.type === 'text') el.value = "";
        calcMoveSpeed();
    }

    // Move Speed Event Listeners
    document.querySelectorAll('.ms-trigger').forEach(el => {
        el.addEventListener('change', calcMoveSpeed);
        el.addEventListener('input', calcMoveSpeed);
    });

    // UI Helpers
    window.toggleSidebar = (side) => {
        const left = document.getElementById('left-panel');
        const right = document.getElementById('right-panel');
        const backdrop = document.getElementById('mobile-backdrop');
        closeSidebars();
        if (side === 'left') { left.classList.add('active'); backdrop.classList.add('active'); }
        if (side === 'right') { right.classList.add('active'); backdrop.classList.add('active'); }
    };
    window.closeSidebars = () => {
        document.getElementById('left-panel').classList.remove('active');
        document.getElementById('right-panel').classList.remove('active');
        document.getElementById('mobile-backdrop').classList.remove('active');
    };
    
    // Init
    calculateExp();
    </script>
</body>
</html>
