<!DOCTYPE html>
<html lang="en">
<head>
    <!-- PWA Manifest & Settings -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#050506">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // navigator.serviceWorker.register('sw.js').catch(err => console.log('Service Worker failed', err));
            });
        }
    </script>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Journals</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Theme: Gold/Amber for Journals */
            --bg: #09090b;
            --sidebar-bg: #121214;
            --card-bg: #18181b;
            --accent: #fbbf24; 
            --accent-dim: rgba(251, 191, 36, 0.1);
            
            --border: #27272a;
            --text-main: #e4e4e7;
            --text-dim: #a1a1aa;
            --danger: #ef4444;
            --success: #00ff88;
            --star-gold: #fbbf24;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text-main);
            margin: 0;
            font-size: 13px;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Layout */
        .interface-container { display: flex; flex-direction: column; height: 100%; width: 100%; }
        .header-bar { background: var(--sidebar-bg); border-bottom: 1px solid var(--border); padding: 10px 20px; flex-shrink: 0; }
        .title-section { display: flex; justify-content: space-between; align-items: center; }
        .main-title { font-size: 16px; font-weight: 700; color: #fff; letter-spacing: 0.5px; }

        .content-grid { display: grid; grid-template-columns: 280px 1fr 300px; flex-grow: 1; overflow: hidden; }
        .panel { background: var(--bg); display: flex; flex-direction: column; border-right: 1px solid var(--border); overflow-y: auto; }
        .panel:last-child { border-right: none; }
        .center-panel { background: #0c0c0e; display: flex; flex-direction: column; padding: 0; }

        /* Components */
        .panel-label { font-size: 11px; font-weight: 600; color: var(--text-dim); margin-bottom: 8px; display: block; text-transform: uppercase; }
        .config-section { padding: 20px; border-bottom: 1px solid var(--border); }
        
        .input-dark { background: var(--card-bg); border: 1px solid var(--border); color: #fff; padding: 8px; border-radius: 6px; width: 100%; }
        .input-dark:focus { border-color: var(--accent); }
        
        .hub-btn { 
            color: var(--text-dim); text-decoration: none; font-weight: 600; font-size: 12px; 
            padding: 8px 12px; border-radius: 6px; transition: 0.2s; 
            border: 1px solid transparent; background: transparent; cursor: pointer; text-align: left; width: 100%;
            display: flex; align-items: center; gap: 10px;
        }
        .hub-btn:hover { color: #fff; background: var(--border); }
        .hub-btn.active { color: var(--accent); background: var(--accent-dim); border-color: var(--accent); }

        /* Recipe Card */
        .recipe-list { padding: 20px; overflow-y: auto; flex-grow: 1; display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 10px; }
        
        .recipe-card {
            background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px;
            padding: 15px; transition: border-color 0.2s; display: flex; flex-direction: column; gap: 10px;
        }
        .recipe-card:hover { border-color: #444; }
        .recipe-card.complete { opacity: 0.6; border-style: dashed; }

        .recipe-header { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .recipe-name { font-weight: 700; color: #fff; font-size: 14px; flex-grow: 1; }
        
        /* New Inputs for Editing */
        .method-select {
            background: var(--bg); /* Darker background for visibility */
            border: 1px solid var(--border); 
            color: var(--text-main); /* Brighter text */
            font-size: 11px; 
            padding: 4px 8px; 
            border-radius: 4px; 
            outline: none; 
            cursor: pointer;
            min-width: 120px; /* Wider to fit text */
            color-scheme: dark; /* Helps standard selects render dark in modern browsers */
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .method-select:hover { border-color: #444; }
        .method-select:focus { 
            border-color: var(--accent); 
            box-shadow: 0 0 0 2px var(--accent-dim);
        }
        .method-select option { background: #121214; color: #fff; } /* Force dark options */

        .recipe-ingredients { font-size: 11px; color: var(--text-dim); line-height: 1.4; margin-top: 5px; }
        .ing-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.05); padding: 4px 0; }
        
        /* New Input for Ingredient Names */
        .ing-name-input {
            background: transparent; border: 1px solid transparent; 
            color: var(--text-main); font-size: 11px; width: 100%;
            padding: 4px; border-radius: 4px; font-family: 'Inter', sans-serif;
            transition: all 0.2s;
        }
        .ing-name-input:hover { background: rgba(255,255,255,0.05); }
        .ing-name-input:focus { 
            border-color: var(--accent); 
            background: rgba(0,0,0,0.3);
            outline: none;
            box-shadow: 0 0 0 1px var(--accent-dim);
        }

        .ing-val-input { 
            font-family: 'JetBrains Mono', monospace; color: var(--accent); 
            background: transparent; border: 1px solid transparent; 
            width: 45px; text-align: right; padding: 4px; border-radius: 4px;
            font-size: 11px;
            transition: all 0.2s;
        }
        .ing-val-input:hover { background: rgba(255,255,255,0.05); }
        .ing-val-input:focus { 
            border-color: var(--accent); 
            background: rgba(0,0,0,0.3);
            outline: none;
            box-shadow: 0 0 0 1px var(--accent-dim);
        }
        
        /* Star Rating */
        .star-rating { display: flex; gap: 4px; align-items: center; cursor: pointer; min-height: 24px; margin-top: 5px; }
        .star { font-size: 18px; color: #333; transition: color 0.1s; padding: 2px; }
        .star.filled { color: var(--star-gold); }
        .star:hover { color: #fff; }

        .star-reset { 
            font-size: 10px; 
            color: var(--danger); 
            opacity: 0.6; 
            margin-left: 8px; 
            padding: 2px 6px;
            border: 1px solid var(--border);
            background: rgba(239, 68, 68, 0.05);
            border-radius: 4px;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            height: 20px;
        }
        .star-reset:hover { opacity: 1; border-color: var(--danger); background: rgba(239, 68, 68, 0.2); }

        /* Stats Box */
        .stat-box { background: var(--card-bg); padding: 15px; border-radius: 8px; border: 1px solid var(--border); text-align: center; }
        .stat-val { font-size: 24px; font-weight: 700; color: var(--accent); font-family: 'JetBrains Mono'; }
        .stat-label { font-size: 11px; color: var(--text-dim); text-transform: uppercase; margin-top: 5px; }

        /* Toggles */
        .toggle-row { display: flex; align-items: center; justify-content: space-between; padding: 5px 0; cursor: pointer; }
        .toggle-switch { width: 36px; height: 20px; background: var(--border); border-radius: 99px; position: relative; transition: 0.2s; }
        .toggle-switch::after { content: ''; position: absolute; top: 2px; left: 2px; width: 16px; height: 16px; background: #fff; border-radius: 50%; transition: 0.2s; }
        input:checked + .toggle-switch { background: var(--accent); }
        input:checked + .toggle-switch::after { transform: translateX(16px); }
        .toggle-input { display: none; }
        
        /* Mobile */
        .mobile-nav { display: none; }
        .mobile-backdrop { display: none; }
        .drawer-header { display: none; } 
        .mobile-only { display: none; }

        @media (max-width: 1000px) {
            .mobile-only { display: block; }
            .content-grid { display: block; height: calc(100dvh - 50px); }
            .header-bar { display: none; }

            .mobile-nav { 
                display: flex; justify-content: space-between; align-items: center; 
                padding: 10px 15px; background: var(--sidebar-bg); border-bottom: 1px solid var(--border); 
                height: 50px; z-index: 50; flex-shrink: 0;
            }
            .nav-trigger { background: transparent; border: 1px solid var(--border); color: var(--text-main); padding: 6px 12px; border-radius: 6px; font-size: 14px; cursor: pointer; }
            
            .left-panel, .right-panel {
                position: fixed; top: 0; bottom: 0; width: 300px; max-width: 85%; z-index: 1001; 
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.3s; 
                visibility: hidden; background: var(--bg); box-shadow: 0 0 50px rgba(0,0,0,0.8);
            }
            .left-panel { left: 0; transform: translateX(-100%); border-right: 1px solid var(--border); }
            .right-panel { right: 0; transform: translateX(100%); border-left: 1px solid var(--border); }
            .left-panel.active, .right-panel.active { transform: translateX(0); visibility: visible; }
            
            .center-panel { height: 100%; width: 100%; border: none; padding: 0; position: relative; z-index: 1; }
            .mobile-backdrop { display: block; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
            .mobile-backdrop.active { opacity: 1; pointer-events: all; }
            
            .drawer-header { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid var(--border); background: var(--sidebar-bg); }
            .user-profile-box { display: flex; align-items: center; gap: 12px; padding: 15px; border-bottom: 1px solid var(--border); }
        }
    </style>
</head>
<body>

    <div class="mobile-nav">
        <button class="nav-trigger" onclick="toggleSidebar('left')">‚ò∞ Filter</button>
        <span style="font-weight:700; color:#fff;">Journals</span>
        <button class="nav-trigger" onclick="toggleSidebar('right')">Stats</button>
    </div>

    <div class="mobile-backdrop" id="mobile-backdrop" onclick="closeSidebars()"></div>
    
    <!-- IMPORT MODAL -->
    <div id="import-modal" style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(5px);">
        <div style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; width: 100%; max-width: 500px; display: flex; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.5);">
            <div style="padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                <span style="font-weight:700; color:#fff;">Update Public Database</span>
                <button onclick="toggleImport(false)" style="background:none; border:none; color:var(--text-dim); cursor:pointer; font-size:18px;">√ó</button>
            </div>
            <div style="padding: 20px;">
                <p style="font-size:12px; color:var(--text-dim); margin-bottom:10px;">
                    <b>Admin Only:</b> This will merge your personal corrections (percentages, names, methods) into the main list and publish it for everyone.
                </p>
                <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:6px; margin-bottom:10px;">
                    <span style="color:var(--accent); font-size:11px;">Target Node: /public_recipes</span>
                </div>
            </div>
            <div style="padding: 15px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px;">
                <button onclick="toggleImport(false)" class="hub-btn">Cancel</button>
                <button onclick="uploadMasterList()" class="hub-btn active" style="border-color:var(--danger); color:var(--danger);">Publish My Fixes</button>
            </div>
        </div>
    </div>

    <div class="interface-container">
        <!-- Global Navigation Bar -->
        <script src="nav.js" defer></script>
            <global-nav></global-nav>
        
        <div class="header-bar">
            <div class="title-section">
                <div style="display:flex; align-items:center;">
                    <span class="main-title">MABI JOURNALS</span>
                </div>
                <user-header></user-header>
            </div>
        </div>

        <div class="content-grid">
            <!-- LEFT PANEL: Journal Selection & Filters -->
            <div class="panel left-panel" id="left-panel">
                <div class="drawer-header">
                    <span class="drawer-title">Selector</span>
                    <button class="drawer-close" onclick="closeSidebars()">√ó</button>
                </div>
                
                <div class="user-profile-box mobile-only">
                    <user-header></user-header>
                </div>

                <!-- JOURNAL SELECTOR -->
                <div class="config-section">
                    <label class="panel-label">Select Journal</label>
                    <button id="btn-j-cooking" class="hub-btn active" onclick="setJournal('cooking')">üç≥ Cooking</button>
                    <button id="btn-j-fishing" class="hub-btn" onclick="setJournal('fishing')" style="opacity:0.5; margin-top:4px;">üé£ Fishing (WIP)</button>
                    <button id="btn-j-taming" class="hub-btn" onclick="setJournal('taming')" style="opacity:0.5; margin-top:4px;">üêæ Taming (WIP)</button>
                </div>

                <!-- COOKING SPECIFIC FILTERS -->
                <div id="ctrl-cooking" style="display:block;">
                    
                    <div class="config-section" style="border-top:1px solid var(--border);">
                        <label class="panel-label">Admin</label>
                        <button class="hub-btn" onclick="toggleImport(true)">üìÇ Update Public Database</button>
                    </div>

                    <div class="config-section">
                        <label class="panel-label">Search</label>
                        <input type="text" id="search-input" class="input-dark" placeholder="Dish name..." oninput="renderRecipes()">
                    </div>

                    <div class="config-section">
                        <label class="panel-label">Settings</label>
                        <label class="toggle-row">
                            <span style="font-size:12px; color:#aaa;">Hide 5-Star Dishes</span>
                            <input type="checkbox" id="hide-completed" class="toggle-input" onchange="renderRecipes()">
                            <div class="toggle-switch"></div>
                        </label>
                    </div>

                    <div class="config-section" style="border-bottom:none;">
                        <label class="panel-label">Cooking Method</label>
                        <div id="method-filters" style="display:flex; flex-direction:column; gap:4px;">
                            <!-- JS populated -->
                        </div>
                    </div>
                </div>

                <!-- FISHING/TAMING FILTERS (Placeholders) -->
                <div id="ctrl-fishing" style="display:none; padding:20px; color:#555; text-align:center;">Fishing filters coming soon.</div>
                <div id="ctrl-taming" style="display:none; padding:20px; color:#555; text-align:center;">Taming filters coming soon.</div>
            </div>

            <!-- CENTER PANEL: Content Area -->
            <div class="panel center-panel">
                <!-- Cooking View -->
                <div id="view-cooking" style="width:100%; height:100%; display:flex; flex-direction:column;">
                    <div id="recipe-container" class="recipe-list"></div>
                    <div id="empty-state" style="display:none; color:var(--text-dim); text-align:center; padding-top:50px;">No recipes found.</div>
                </div>

                <!-- Fishing View -->
                <div id="view-fishing" style="display:none; width:100%; height:100%; align-items:center; justify-content:center; color:var(--text-dim);">
                    <h3>Fishing Journal</h3>
                    <p>Under Construction</p>
                </div>

                <!-- Taming View -->
                <div id="view-taming" style="display:none; width:100%; height:100%; align-items:center; justify-content:center; color:var(--text-dim);">
                    <h3>Taming Journal</h3>
                    <p>Under Construction</p>
                </div>
            </div>

            <!-- RIGHT PANEL: Stats -->
            <div class="panel right-panel" id="right-panel">
                <div class="drawer-header">
                    <span class="drawer-title">Stats</span>
                    <button class="drawer-close" onclick="closeSidebars()">√ó</button>
                </div>

                <!-- COOKING STATS -->
                <div id="stats-cooking" style="display:block;">
                    <div class="config-section">
                        <label class="panel-label">Progress</label>
                        <div class="stat-box">
                            <div id="stat-completed" class="stat-val">0</div>
                            <div class="stat-label">5-Star Dishes</div>
                        </div>
                        <div class="stat-box" style="margin-top:10px;">
                            <div id="stat-started" class="stat-val">0</div>
                            <div class="stat-label">Dishes Started</div>
                        </div>
                        <div class="stat-box" style="margin-top:10px;">
                            <div id="stat-total" class="stat-val">0</div>
                            <div class="stat-label">Total Stars Earned</div>
                        </div>
                    </div>

                    <div class="config-section" style="border-bottom:none;">
                        <label class="panel-label">Sort By</label>
                        <div style="display:flex; flex-direction:column; gap:8px;">
                            <button class="hub-btn active" onclick="setSort('default')" id="sort-default">Journal Order</button>
                            <button class="hub-btn" onclick="setSort('name')" id="sort-name">Name (A-Z)</button>
                            <button class="hub-btn" onclick="setSort('stars-asc')" id="sort-stars-asc">Stars (Low to High)</button>
                            <button class="hub-btn" onclick="setSort('stars-desc')" id="sort-stars-desc">Stars (High to Low)</button>
                        </div>
                    </div>
                </div>
                
                <div id="stats-fishing" style="display:none; padding:20px; text-align:center; color:var(--text-dim);">No stats available.</div>
                <div id="stats-taming" style="display:none; padding:20px; text-align:center; color:var(--text-dim);">No stats available.</div>
            </div>
        </div>
    </div>

    <script>
    const firebaseConfig = { apiKey: "AIzaSyC7A3Rzi-VddhqZiFGjHjjqBwCdX1ks6yM", authDomain: "mabinogi-tracker.firebaseapp.com", databaseURL: "https://mabinogi-tracker-default-rtdb.firebaseio.com", projectId: "mabinogi-tracker", storageBucket: "mabinogi-tracker.firebasestorage.app", appId: "1:267690802644:web:fccdd005d5c8990504ea41", measurementId: "G-VBDBKQ3M1B" };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

    let RECIPE_DB = []; // Initialize empty, populate from Firebase
    let userStars = {}; 
    let userOverrides = {}; // New storage for custom recipe data
    let currentUser = null;
    let activeMethod = 'All';
    let currentSort = 'default'; // Default is now Journal Order
    let currentJournal = 'cooking';

    // Helper: Get unique methods
    // Initialized from the static fallback list
    let uniqueMethods = [];

    // --- RESTORED FUNCTIONS ---
    
    function sanitizeId(str) {
        return str.replace(/[^a-z0-9]/gi, '_').toLowerCase();
    }

    function toggleImport(show) {
        document.getElementById('import-modal').style.display = show ? 'flex' : 'none';
    }

    function processImport() {
        alert("This feature is now mainly for custom updates since the list is hardcoded!");
        toggleImport(false);
    }

    // NEW: Upload Local Static List to Firebase Public DB
    function uploadMasterList() {
        if (!currentUser || currentUser.isGuest) {
            alert("You must be logged in to update the public database.");
            return;
        }
        
        // Safety check to prevent wiping the DB with an empty local list
        if (!RECIPE_DB || RECIPE_DB.length === 0) {
            alert("Local list is empty! Cannot upload to DB.");
            return;
        }

        if (confirm("WARNING: This will overwrite the PUBLIC database with the recipes currently visible to YOU (including your edits). Are you sure?")) {
            const btn = document.querySelector('#import-modal .hub-btn.active');
            const originalText = btn.innerText;
            btn.innerText = "Merging & Uploading...";
            btn.disabled = true;

            // 1. Create a deep copy of the current public list
            let newPublicList = JSON.parse(JSON.stringify(RECIPE_DB));

            // 2. Merge User Overrides into this new list
            newPublicList.forEach(recipe => {
                const overrides = userOverrides[recipe.name];
                if (overrides) {
                    // Update Method
                    if (overrides.method) {
                        recipe.method = overrides.method;
                    }

                    // Update Ingredients
                    // We check indices 0, 1, 2 because the UI exposes 3 slots
                    for (let i = 0; i < 3; i++) {
                        const hasNameOverride = overrides.names && overrides.names[i] !== undefined;
                        const hasRatioOverride = overrides.ratios && overrides.ratios[i] !== undefined;

                        if (hasNameOverride || hasRatioOverride) {
                            // Ensure the ingredient object exists at this index in the new list
                            if (!recipe.ingredients[i]) {
                                recipe.ingredients[i] = { n: '', r: 0 };
                            }

                            if (hasNameOverride) {
                                recipe.ingredients[i].n = overrides.names[i];
                            }
                            if (hasRatioOverride) {
                                recipe.ingredients[i].r = Number(overrides.ratios[i]);
                            }
                        }
                    }
                }
            });

            // 3. Send the merged list to Firebase
            db.ref('public_recipes').set(newPublicList)
                .then(() => {
                    alert("Success! Your custom recipes have been published to the main database.");
                    toggleImport(false);
                })
                .catch(e => {
                    alert("Error uploading: " + e.message + "\n\nCheck your database rules.");
                })
                .finally(() => {
                    btn.innerText = originalText;
                    btn.disabled = false;
                });
        }
    }

    function saveStars() {
        if (currentUser && !currentUser.isGuest) {
            db.ref(`users/${currentUser.uid}/cooking_stars`).set(userStars);
        } else {
            localStorage.setItem('mabi_cooking_journal', JSON.stringify(userStars));
        }
    }

    function saveOverrides() {
        if (currentUser && !currentUser.isGuest) {
            db.ref(`users/${currentUser.uid}/custom_recipes`).set(userOverrides);
        } else {
            localStorage.setItem('mabi_cooking_overrides', JSON.stringify(userOverrides));
        }
    }

    // New function to update custom data
    function updateCustomData(dishName, type, val, index = null) {
        if (!userOverrides[dishName]) {
            userOverrides[dishName] = {};
        }

        if (type === 'method') {
            userOverrides[dishName].method = val;
        } else if (type === 'ratio') {
            if (!userOverrides[dishName].ratios) userOverrides[dishName].ratios = {};
            userOverrides[dishName].ratios[index] = Number(val);
        } else if (type === 'name') {
            if (!userOverrides[dishName].names) userOverrides[dishName].names = {};
            userOverrides[dishName].names[index] = val;
        }

        saveOverrides();
    }

    function setStar(dishName, rating) {
        // Toggle Logic: If clicking the current rating, reset to 0
        const currentRating = userStars[dishName] || 0;
        
        if (currentRating === rating) {
            userStars[dishName] = 0; // Reset
        } else {
            userStars[dishName] = rating; // Set new
        }

        saveStars(); 
        renderRecipes();
        updateStats();
    }

    function setSort(type) {
        currentSort = type;
        document.querySelectorAll('.hub-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`sort-${type}`).classList.add('active');
        document.getElementById(`btn-j-${currentJournal}`).classList.add('active'); // Keep journal btn active
        renderRecipes();
    }

    function setMethod(m) {
        activeMethod = m;
        renderRecipes();
        renderFilters(); 
    }

    function setJournal(j) {
        currentJournal = j;
        document.querySelectorAll('.hub-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`btn-j-${j}`).classList.add('active');
        
        // Hide all controls/views/stats first
        ['cooking', 'fishing', 'taming'].forEach(type => {
            document.getElementById(`ctrl-${type}`).style.display = 'none';
            document.getElementById(`view-${type}`).style.display = 'none';
            document.getElementById(`stats-${type}`).style.display = 'none';
        });

        // Show selected
        document.getElementById(`ctrl-${j}`).style.display = 'block';
        if(j === 'cooking') document.getElementById(`view-${j}`).style.display = 'flex'; // flex for cooking view
        else document.getElementById(`view-${j}`).style.display = 'flex'; // flex for placeholders
        document.getElementById(`stats-${j}`).style.display = 'block';
    }

    function renderFilters() {
        if(!RECIPE_DB.length) return;
        const methods = [...new Set(RECIPE_DB.map(r => r.method))].sort();
        const container = document.getElementById('method-filters');
        let html = `<button class="hub-btn ${activeMethod==='All'?'active':''}" onclick="setMethod('All')">All Methods</button>`;
        methods.forEach(method => {
            html += `<button class="hub-btn ${activeMethod===method?'active':''}" onclick="setMethod('${method}')">${method}</button>`;
        });
        container.innerHTML = html;
    }

    function renderRecipes() {
        const container = document.getElementById('recipe-container');
        // Capture focus before re-render
        const focusedId = document.activeElement ? document.activeElement.id : null;

        const search = document.getElementById('search-input').value.toLowerCase();
        const hideCompleted = document.getElementById('hide-completed').checked;

        let filtered = RECIPE_DB.filter(r => {
            const stars = userStars[r.name] || 0;
            if (hideCompleted && stars === 5) return false;
            
            // Note: Filtering by method checks the PUBLIC DB value, not the overridden one, to keep the list consistent
            // But we could change this to check the overridden value if desired. For now, strict DB filter.
            if (activeMethod !== 'All' && r.method !== activeMethod) return false;
            
            if (search && !r.name.toLowerCase().includes(search)) return false;
            return true;
        });

        filtered.sort((a, b) => {
            if (currentSort === 'default') return 0; // Maintain original array order (Journal Order)
            
            const starsA = userStars[a.name] || 0;
            const starsB = userStars[b.name] || 0;
            if (currentSort === 'stars-asc') return starsA - starsB;
            if (currentSort === 'stars-desc') return starsB - starsA;
            return a.name.localeCompare(b.name);
        });

        container.innerHTML = '';
        if(filtered.length === 0) {
            document.getElementById('empty-state').style.display = 'block';
            return;
        }
        document.getElementById('empty-state').style.display = 'none';

        filtered.forEach(r => {
            const stars = userStars[r.name] || 0;
            const isComplete = stars === 5;
            const safeName = sanitizeId(r.name);
            
            // Check for overrides
            const customData = userOverrides[r.name] || {};
            const displayMethod = customData.method || r.method;

            let starsHtml = '';
            for(let i=1; i<=5; i++) {
                starsHtml += `<span class="star ${i <= stars ? 'filled' : ''}" onclick="setStar('${r.name.replace(/'/g, "\\'")}', ${i})">‚òÖ</span>`;
            }

            // Explicit Clear Button
            let clearBtn = '';
            if (stars > 0) {
                clearBtn = `<span class="star-reset" onclick="setStar('${r.name.replace(/'/g, "\\'")}', 0)" title="Clear rating">Clear</span>`;
            }

            // Generate Method Dropdown
            let methodOptions = uniqueMethods.map(m => 
                `<option value="${m}" ${m === displayMethod ? 'selected' : ''}>${m}</option>`
            ).join('');
            
            const methodSelect = `<select id="method-${safeName}" class="method-select" onchange="updateCustomData('${r.name.replace(/'/g, "\\'")}', 'method', this.value)">${methodOptions}</select>`;

            let ingHtml = '';
            // Force 3 ingredient slots
            for (let idx = 0; idx < 3; idx++) {
                // Get default data if it exists in DB, otherwise use empty placeholders
                const defaultIng = r.ingredients[idx] || { n: '', r: 0 };
                
                // Get custom data overrides
                // Note: user might input a name even if default name is empty.
                const ingName = (customData.names && customData.names[idx] !== undefined) ? customData.names[idx] : defaultIng.n;
                const ratio = (customData.ratios && customData.ratios[idx] !== undefined) ? customData.ratios[idx] : defaultIng.r;
                
                // Input for percentage
                const valInput = `<input type="number" id="ratio-${safeName}-${idx}" class="ing-val-input" value="${ratio}" autocomplete="off" onchange="updateCustomData('${r.name.replace(/'/g, "\\'")}', 'ratio', this.value, ${idx})">`;
                
                // Input for Name
                const nameInput = `<input type="text" id="name-${safeName}-${idx}" class="ing-name-input" value="${ingName}" placeholder="Ingredient ${idx+1}" autocomplete="off" onchange="updateCustomData('${r.name.replace(/'/g, "\\'")}', 'name', this.value, ${idx})">`;

                ingHtml += `<div class="ing-row">
                    <div style="flex-grow:1; margin-right:5px;">${nameInput}</div>
                    <div style="display:flex; align-items:center;">
                        ${valInput}<span style="color:var(--text-dim); margin-left:2px;">%</span>
                    </div>
                </div>`;
            }

            const wikiUrl = `https://wiki.mabinogiworld.com/view/${r.name.replace(/ /g, '_')}`;

            const card = document.createElement('div');
            card.className = `recipe-card ${isComplete ? 'complete' : ''}`;
            card.innerHTML = `
                <div class="recipe-header">
                    <a href="${wikiUrl}" target="_blank" tabindex="-1" class="recipe-name" style="text-decoration:none; color:inherit;">${r.name} üîó</a>
                    ${methodSelect}
                </div>
                <div class="recipe-ingredients">
                    ${ingHtml}
                </div>
                <div class="star-rating" title="Click same star to reset">
                    ${starsHtml}
                    ${clearBtn}
                </div>
            `;
            container.appendChild(card);
        });

        // Restore focus
        if (focusedId) {
            const el = document.getElementById(focusedId);
            if (el) {
                el.focus();
                // Optional: restore cursor position if needed, but default focus usually puts at end for inputs
            }
        }
    }

    function updateStats() {
        const totalDishes = RECIPE_DB.length;
        if(totalDishes === 0) {
            document.getElementById('stat-completed').innerText = `0 / 0`;
            document.getElementById('stat-started').innerText = `0 / 0`;
            document.getElementById('stat-total').innerText = 0;
            return;
        }
        const entries = Object.entries(userStars);
        const validStars = entries.filter(([k,v]) => RECIPE_DB.some(r => r.name === k));
        
        // Count dishes with exactly 5 stars
        const completed = validStars.filter(([k, v]) => v === 5).length;
        
        // Count dishes with ANY stars (> 0)
        const started = validStars.filter(([k, v]) => v > 0).length;
        
        // Sum of all stars
        const totalStars = validStars.reduce((acc, [k, v]) => acc + v, 0);

        // Update Stats
        document.getElementById('stat-completed').innerText = `${completed} / ${totalDishes}`;
        document.getElementById('stat-started').innerText = `${started} / ${totalDishes}`;
        document.getElementById('stat-total').innerText = totalStars;
    }

    window.toggleSidebar = (side) => {
        const left = document.getElementById('left-panel');
        const right = document.getElementById('right-panel');
        const backdrop = document.getElementById('mobile-backdrop');
        closeSidebars();
        if (side === 'left') { left.classList.add('active'); backdrop.classList.add('active'); }
        if (side === 'right') { right.classList.add('active'); backdrop.classList.add('active'); }
    };
    window.closeSidebars = () => {
        document.getElementById('left-panel').classList.remove('active');
        document.getElementById('right-panel').classList.remove('active');
        document.getElementById('mobile-backdrop').classList.remove('active');
    };

    // --- MAIN DATA LOADING LOGIC ---

    // 1. Initialize Public Data Listener (OUTSIDE of Auth)
    // This ensures data loads immediately regardless of login state
    db.ref('public_recipes').on('value', snap => {
        const publicData = snap.val();
        if (publicData) {
            console.log("Syncing recipes from public DB...");
            
            // Handle both Array and Object formats from Firebase
            if (Array.isArray(publicData)) {
                RECIPE_DB = publicData;
            } else {
                RECIPE_DB = Object.values(publicData);
            }

            // Update derived data dynamically
            uniqueMethods = [...new Set(RECIPE_DB.map(r => r.method))].sort();
            
            renderRecipes();
            updateStats();
            renderFilters();
        } else {
            console.log("No public data found, using static fallback.");
        }
    }, (error) => {
        console.error("Error reading public DB:", error);
    });

    // 2. Auth Listener for User-Specific Data
    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = user;
            db.ref(`users/${user.uid}/profile`).on('value', snap => {
                const profile = snap.val();
                if(profile) {
                    localStorage.setItem('mabi_user_cache_' + user.uid, JSON.stringify(profile));
                    document.querySelectorAll('user-header').forEach(h => { if(h.updateUI) h.updateUI(user); });
                }
            });

            // Listen for Star ratings
            db.ref(`users/${user.uid}/cooking_stars`).on('value', snap => {
                userStars = snap.val() || {};
                renderRecipes();
                updateStats();
            });

            // Listen for Recipe Overrides (NEW)
            db.ref(`users/${user.uid}/custom_recipes`).on('value', snap => {
                userOverrides = snap.val() || {};
                renderRecipes();
            });

        } else {
            currentUser = { uid: 'local_guest', isGuest: true };
            const localStars = localStorage.getItem('mabi_cooking_journal');
            userStars = localStars ? JSON.parse(localStars) : {};
            
            const localOverrides = localStorage.getItem('mabi_cooking_overrides');
            userOverrides = localOverrides ? JSON.parse(localOverrides) : {};

            renderRecipes();
            updateStats();
        }
    });

    setMethod('All');
    renderRecipes();
    </script>
</body>
</html>
